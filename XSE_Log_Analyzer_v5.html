<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="theme-color" content="#0b0d14">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="XSE Logs">
<meta name="description" content="Analizador de logs del servicio XSE de sincronizaciÃ³n OXXO">
<title>XSE Log Analyzer</title>
<script>
// Inline PWA manifest
const manifest = {
  name: "XSE Log Analyzer",
  short_name: "XSE Logs",
  description: "Analizador de logs del servicio XSE",
  start_url: "./",
  display: "standalone",
  background_color: "#0b0d14",
  theme_color: "#f0a500",
  icons: [{
    src: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='18' fill='%23f0a500'/%3E%3Ctext y='72' x='50' text-anchor='middle' font-size='64' font-family='monospace' font-weight='700'%3E%E2%9F%81%3C/text%3E%3C/svg%3E",
    sizes: "any", type: "image/svg+xml"
  }]
};
const blob = new Blob([JSON.stringify(manifest)], {type:"application/json"});
const url = URL.createObjectURL(blob);
const l = document.createElement("link");
l.rel = "manifest"; l.href = url;
document.currentScript.after(l);
</script>
<style>
:root{
  --bg:#0b0d14;--surf:#12151f;--surf2:#181c2a;--bdr:#1e2235;
  --acc:#f0a500;--red:#e05252;--teal:#2ec4b6;--blue:#4a90d9;
  --mut:#5a607a;--txt:#d4d8e8;--dim:#8890aa;--grn:#4caf7d;--purple:#9b5de5;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{background:var(--bg);color:var(--txt);font-family:'Segoe UI',system-ui,sans-serif;min-height:100vh;}
::-webkit-scrollbar{width:6px;height:6px;}
::-webkit-scrollbar-track{background:var(--bg);}
::-webkit-scrollbar-thumb{background:#2a2e3f;border-radius:3px;}

/* â”€ Layout â”€ */
.app{padding:20px;}
.header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;flex-wrap:wrap;gap:12px;}
.logo{display:flex;align-items:center;gap:12px;}
.logo-icon{width:38px;height:38px;background:var(--acc);border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:20px;color:#000;font-family:monospace;font-weight:700;flex-shrink:0;}
.logo-title{font-size:20px;font-weight:700;font-family:'Courier New',monospace;letter-spacing:-.02em;}
.logo-title span{color:var(--acc);}
.logo-sub{font-size:11px;color:var(--mut);margin-top:2px;}
.status-pill{display:flex;align-items:center;gap:7px;background:var(--surf);border:1px solid var(--bdr);border-radius:20px;padding:5px 12px;}
.status-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0;}
.status-dot.active{background:var(--grn);box-shadow:0 0 8px var(--grn);}
.status-dot.idle{background:var(--mut);}
.status-text{font-size:11px;color:var(--dim);}

/* â”€ Upload â”€ */
.upload-area{border:2px dashed var(--bdr);border-radius:12px;padding:16px 20px;margin-bottom:16px;transition:all .2s;position:relative;}
.upload-area:hover,.upload-area.drag{border-color:var(--acc);background:#1a140022;}
.upload-inner{display:flex;align-items:center;gap:14px;flex-wrap:wrap;}
.upload-icon{font-size:26px;flex-shrink:0;}
.upload-texts{flex:1;min-width:180px;}
.upload-main{font-size:13px;color:var(--txt);margin-bottom:3px;}
.upload-main code{color:var(--acc);background:#f0a50015;padding:1px 5px;border-radius:3px;font-family:monospace;}
.upload-hint{font-size:11px;color:var(--dim);line-height:1.5;}
.upload-btn{background:var(--acc);border:none;border-radius:8px;padding:9px 18px;color:#000;font-size:12px;font-weight:700;cursor:pointer;font-family:inherit;white-space:nowrap;flex-shrink:0;}
.upload-btn:hover{opacity:.9;}

/* â”€ Validation badge â”€ */
.val-row{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:16px;align-items:stretch;}
.val-card{flex:1;min-width:220px;background:var(--surf);border:1px solid var(--bdr);border-radius:10px;padding:12px 16px;display:flex;gap:12px;align-items:flex-start;transition:border-color .3s;}
.val-card.valid{border-color:var(--grn);}
.val-card.invalid{border-color:var(--red);}
.val-card.warning{border-color:var(--acc);}
.val-icon{font-size:22px;flex-shrink:0;margin-top:1px;}
.val-body{flex:1;min-width:0;}
.val-filename{font-size:12px;font-weight:600;color:var(--txt);font-family:monospace;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;margin-bottom:4px;}
.val-status{font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:.08em;margin-bottom:4px;}
.val-status.ok{color:var(--grn);}
.val-status.err{color:var(--red);}
.val-status.warn{color:var(--acc);}
.val-detail{font-size:10px;color:var(--dim);line-height:1.5;}
.val-checks{display:flex;flex-direction:column;gap:2px;margin-top:6px;}
.val-check{font-size:10px;display:flex;gap:5px;align-items:center;}
.val-check .ck{font-size:11px;}
.val-check .ck.ok{color:var(--grn);}
.val-check .ck.fail{color:var(--red);}
.val-check .ck.warn{color:var(--acc);}

/* â”€ Welcome screen â”€ */
.welcome{max-width:780px;margin:0 auto;padding:10px 0 40px;}
.welcome-hero{text-align:center;padding:40px 20px 32px;border:1px solid var(--bdr);border-radius:14px;background:var(--surf);margin-bottom:24px;}
.welcome-hero-icon{font-size:52px;margin-bottom:16px;}
.welcome-hero-title{font-size:22px;font-weight:700;font-family:'Courier New',monospace;color:var(--acc);margin-bottom:8px;}
.welcome-hero-sub{font-size:13px;color:var(--dim);line-height:1.7;max-width:500px;margin:0 auto;}
.welcome-steps{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px;margin-bottom:24px;}
.step-card{background:var(--surf);border:1px solid var(--bdr);border-radius:10px;padding:18px 16px;}
.step-num{width:26px;height:26px;border-radius:50%;background:var(--acc);color:#000;font-size:12px;font-weight:700;display:flex;align-items:center;justify-content:center;font-family:monospace;margin-bottom:10px;}
.step-title{font-size:12px;font-weight:600;color:var(--txt);margin-bottom:6px;}
.step-body{font-size:11px;color:var(--dim);line-height:1.6;}
.step-body code{color:var(--teal);background:#2ec4b615;padding:1px 4px;border-radius:3px;font-family:monospace;}
.welcome-tips{background:var(--surf);border:1px solid var(--bdr);border-left:3px solid var(--blue);border-radius:10px;padding:16px 18px;margin-bottom:24px;}
.tips-title{font-size:11px;text-transform:uppercase;letter-spacing:.12em;color:var(--blue);margin-bottom:10px;}
.tip-row{display:flex;gap:8px;margin-bottom:7px;font-size:12px;color:var(--dim);align-items:flex-start;line-height:1.5;}
.tip-row:last-child{margin-bottom:0;}
.tip-row .bullet{color:var(--blue);flex-shrink:0;margin-top:1px;}
.welcome-valid{background:var(--surf);border:1px solid var(--bdr);border-left:3px solid var(--grn);border-radius:10px;padding:16px 18px;}
.valid-title{font-size:11px;text-transform:uppercase;letter-spacing:.12em;color:var(--grn);margin-bottom:10px;}
.sig-row{display:flex;gap:8px;margin-bottom:6px;font-size:11px;align-items:center;}
.sig-label{color:var(--dim);width:120px;flex-shrink:0;}
.sig-val{color:var(--teal);font-family:monospace;font-size:10px;background:#2ec4b615;padding:2px 7px;border-radius:4px;}

/* â”€ Tabs â”€ */
.tabs{display:flex;border-bottom:1px solid var(--bdr);margin-bottom:24px;overflow-x:auto;gap:0;}
.tab-btn{background:transparent;border:none;border-bottom:2px solid transparent;color:var(--mut);padding:10px 18px;font-size:12px;cursor:pointer;white-space:nowrap;transition:color .15s;font-family:inherit;font-weight:400;}
.tab-btn:hover{color:var(--acc);}
.tab-btn.active{background:var(--surf);border-bottom-color:var(--acc);color:var(--acc);font-weight:600;}

/* â”€ KPIs â”€ */
.kpi-row{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:20px;}
.kpi{background:var(--surf);border:1px solid var(--bdr);border-radius:8px;padding:18px 22px;flex:1;min-width:140px;}
.kpi-label{font-size:11px;text-transform:uppercase;letter-spacing:.12em;color:var(--mut);margin-bottom:6px;}
.kpi-value{font-size:32px;font-weight:700;font-family:'Courier New',monospace;line-height:1;}
.kpi-sub{font-size:11px;color:var(--dim);margin-top:6px;}
.sec-title{font-size:11px;text-transform:uppercase;letter-spacing:.14em;color:var(--mut);margin:28px 0 14px;border-bottom:1px solid var(--bdr);padding-bottom:6px;}
.chart-box{background:var(--surf);border:1px solid var(--bdr);border-radius:8px;padding:16px;margin-bottom:4px;}
.chart-row{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:4px;}
canvas{display:block;}

/* â”€ Timeline controls â”€ */
.tl-wrap{background:var(--surf);border:1px solid var(--bdr);border-radius:8px;padding:14px 16px;margin-bottom:4px;}
.tl-header{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;margin-bottom:10px;}
.tl-meta{display:flex;flex-direction:column;gap:2px;}
.tl-period{font-size:11px;color:var(--teal);font-family:monospace;}
.tl-hint{font-size:10px;color:var(--mut);font-style:italic;margin-top:2px;}
.tl-controls{display:flex;gap:4px;align-items:center;flex-wrap:wrap;}
.tl-btn{background:transparent;border:1px solid var(--bdr);border-radius:5px;color:var(--dim);font-size:10px;padding:4px 11px;cursor:pointer;font-family:inherit;transition:all .15s;white-space:nowrap;}
.tl-btn:hover{border-color:var(--acc);color:var(--acc);}
.tl-btn.active{background:var(--acc);border-color:var(--acc);color:#000;font-weight:700;}
.tl-canvas-wrap{position:relative;}
/* â”€ Day-detail panel â”€ */
.day-detail{border:1px solid var(--acc);border-left:4px solid var(--acc);border-radius:8px;margin-top:10px;overflow:hidden;animation:slideIn .15s ease;}
@keyframes slideIn{from{opacity:0;transform:translateY(-6px);}to{opacity:1;transform:translateY(0);}}
.day-detail-hd{display:flex;align-items:center;justify-content:space-between;padding:11px 16px;background:#0d1018;border-bottom:1px solid var(--bdr);flex-wrap:wrap;gap:8px;}
.day-detail-date{font-size:16px;font-weight:700;font-family:'Courier New',monospace;color:var(--acc);}
.day-detail-stats{display:flex;gap:16px;align-items:center;flex-wrap:wrap;}
.day-detail-stat{font-size:11px;color:var(--dim);}
.day-detail-stat strong{color:var(--txt);}
.day-detail-close{background:transparent;border:1px solid var(--bdr);border-radius:5px;color:var(--dim);font-size:12px;cursor:pointer;padding:3px 10px;font-family:inherit;flex-shrink:0;}
.day-detail-close:hover{color:var(--txt);border-color:var(--mut);}
.day-chips{display:flex;gap:6px;flex-wrap:wrap;padding:10px 16px;border-bottom:1px solid var(--bdr);background:var(--surf);}
.day-chip{font-size:10px;border-radius:4px;padding:3px 9px;border:1px solid transparent;font-family:monospace;font-weight:600;}
.day-table-wrap{overflow-x:auto;max-height:300px;overflow-y:auto;}
.day-table{width:100%;border-collapse:collapse;font-size:11px;}
.day-table th{position:sticky;top:0;z-index:1;padding:7px 12px;text-align:left;color:var(--mut);font-weight:500;font-size:10px;text-transform:uppercase;letter-spacing:.08em;border-bottom:1px solid var(--bdr);background:#0d1018;cursor:pointer;white-space:nowrap;}
.day-table th:hover{color:var(--acc);}
.day-table td{padding:7px 12px;border-bottom:1px solid var(--bdr);}
.day-table tr{cursor:pointer;transition:background .1s;}
.day-table tr:hover td{background:#181b28;}

/* â”€ Error banner + table â”€ */
.err-banner{background:#1a0f0f;border:1px solid #3d1a1a;border-radius:8px;padding:14px 18px;display:flex;align-items:center;gap:12px;margin:20px 0;}
.err-table{background:var(--surf);border:1px solid var(--bdr);border-radius:8px;overflow:hidden;width:100%;}
.err-table table{width:100%;border-collapse:collapse;font-size:12px;}
.err-table th{padding:10px 16px;text-align:left;color:var(--mut);font-weight:500;font-size:10px;text-transform:uppercase;letter-spacing:.1em;background:#0d1018;border-bottom:1px solid var(--bdr);}
.err-table td{padding:10px 16px;border-bottom:1px solid var(--bdr);}
.progress-bar{width:60px;height:4px;background:var(--bdr);border-radius:2px;overflow:hidden;display:inline-block;vertical-align:middle;margin-right:6px;}
.progress-fill{height:100%;background:var(--acc);border-radius:2px;}
.diag-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.diag-card{background:var(--surf);border:1px solid var(--bdr);border-radius:8px;padding:14px 16px;}
.diag-card-hd{display:flex;align-items:center;gap:8px;margin-bottom:8px;}
.diag-card-msg{font-size:12px;color:var(--dim);line-height:1.6;}

/* â”€ Log Viewer â”€ */
.toolbar{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px;align-items:center;}
.search-input,.filter-sel{background:var(--surf);border:1px solid var(--bdr);border-radius:7px;padding:8px 12px;color:var(--txt);font-size:12px;outline:none;font-family:inherit;}
.search-input{flex:1;min-width:200px;}
.search-input:focus,.filter-sel:focus{border-color:var(--acc);}
.filter-sel{padding:8px 10px;font-size:11px;cursor:pointer;}
.filter-sel option{background:#12151f;}
.hint{font-size:11px;color:var(--mut);margin-bottom:10px;padding:6px 12px;background:var(--surf);border-radius:6px;border:1px solid var(--bdr);display:inline-block;}
.log-table-wrap{background:var(--surf);border:1px solid var(--bdr);border-radius:8px;overflow:hidden;}
.log-table{width:100%;border-collapse:collapse;font-size:12px;}
.log-table th{padding:9px 12px;text-align:left;color:var(--mut);font-weight:500;font-size:10px;text-transform:uppercase;letter-spacing:.1em;border-bottom:1px solid var(--bdr);cursor:pointer;user-select:none;white-space:nowrap;background:#0d1018;}
.log-table th:hover,.log-table th.sorted{color:var(--acc);}
.log-table td{padding:8px 12px;border-bottom:1px solid var(--bdr);}
.log-table tr{cursor:pointer;transition:background .1s;}
.log-table tr:hover td{background:#181b28;}
.log-table tr.selected td{background:#1a1f30;}
.tag{display:inline-block;border-radius:4px;padding:2px 7px;font-size:10px;font-family:monospace;font-weight:700;}
.tag-vt{background:#f0a50022;color:var(--acc);}
.tag-sql26{background:#e0525222;color:var(--red);border:1px solid #e0525244;}
.tag-app{background:#2ec4b622;color:var(--teal);border:1px solid #2ec4b644;}
.tag-other{background:#f0a50022;color:var(--acc);border:1px solid #f0a50044;}
.td-date{color:var(--teal);font-family:monospace;font-size:11px;white-space:nowrap;}
.td-time{color:var(--mut);}
.td-comp{color:var(--blue);font-family:monospace;font-size:11px;}
.td-meth{color:var(--txt);font-size:11px;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.td-desc{color:var(--dim);font-size:11px;max-width:250px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.pagination{padding:10px 16px;border-top:1px solid var(--bdr);display:flex;align-items:center;justify-content:space-between;background:#0d1018;flex-wrap:wrap;gap:8px;}
.page-info{font-size:11px;color:var(--mut);}
.page-btns{display:flex;gap:4px;}
.page-btn{background:transparent;border:1px solid var(--bdr);border-radius:5px;color:var(--txt);padding:4px 10px;font-size:11px;cursor:pointer;font-family:inherit;}
.page-btn:hover:not(:disabled){background:#1e2235;}
.page-btn:disabled{color:var(--mut);cursor:not-allowed;}
.page-btn.active{background:var(--acc);border-color:var(--acc);color:#000;}

/* â”€ Raw panel â”€ */
.raw-panel{position:fixed;top:0;right:0;bottom:0;width:min(45vw,680px);background:var(--surf);border-left:1px solid var(--bdr);z-index:200;display:flex;flex-direction:column;box-shadow:-8px 0 40px #00000070;}
.raw-panel-hd{padding:14px 18px;border-bottom:1px solid var(--bdr);background:#0d1018;display:flex;justify-content:space-between;align-items:flex-start;gap:12px;}
.raw-panel-meta{flex:1;min-width:0;}
.raw-panel-badges{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:6px;}
.badge{font-size:10px;border-radius:4px;padding:2px 8px;font-family:monospace;border:1px solid transparent;}
.raw-panel-method{font-family:monospace;font-size:13px;color:var(--txt);font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;margin-bottom:2px;}
.raw-panel-ts{font-size:11px;color:var(--dim);}
.close-btn{background:transparent;border:1px solid var(--bdr);border-radius:6px;color:var(--dim);font-size:16px;cursor:pointer;padding:4px 10px;flex-shrink:0;line-height:1;font-family:inherit;}
.close-btn:hover{color:var(--txt);}
.chips-row{padding:10px 18px;border-bottom:1px solid var(--bdr);display:flex;flex-wrap:wrap;gap:8px;}
.chip{border-radius:6px;padding:4px 10px;border:1px solid transparent;}
.chip-lbl{font-size:9px;color:var(--mut);text-transform:uppercase;letter-spacing:.1em;}
.chip-val{font-size:12px;font-family:monospace;font-weight:600;}
.err-desc-row{padding:10px 18px;border-bottom:1px solid var(--bdr);background:#0f0a00;}
.raw-content-hd{padding:9px 18px;border-bottom:1px solid var(--bdr);display:flex;justify-content:space-between;align-items:center;}
.raw-content-title{font-size:10px;color:var(--mut);text-transform:uppercase;letter-spacing:.1em;}
.copy-btn{background:transparent;border:1px solid var(--bdr);border-radius:5px;color:var(--dim);font-size:10px;cursor:pointer;padding:3px 10px;font-family:inherit;transition:color .2s;}
.copy-btn:hover,.copy-btn.copied{color:var(--grn);}
.raw-content-body{flex:1;overflow-y:auto;padding:14px 18px;}
.raw-pre{margin:0;font-size:11px;line-height:1.8;font-family:'Courier New',monospace;color:var(--dim);white-space:pre-wrap;word-break:break-all;}

/* â”€ AI â”€ */
.ai-info{background:#0d1118;border:1px solid #1e3a5f;border-radius:8px;padding:14px 18px;margin-bottom:20px;}
.preset-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:20px;}
.preset-btn{background:var(--surf);border:1px solid var(--bdr);border-radius:8px;padding:12px 16px;color:var(--txt);font-size:12px;cursor:pointer;text-align:left;font-family:inherit;transition:border-color .2s;}
.preset-btn:hover:not(:disabled){border-color:var(--acc);}
.preset-btn:disabled{opacity:.5;cursor:not-allowed;}
.query-row{display:flex;gap:10px;margin-bottom:20px;}
.query-input{flex:1;background:var(--surf);border:1px solid var(--bdr);border-radius:8px;padding:10px 14px;color:var(--txt);font-size:12px;outline:none;font-family:inherit;}
.query-input:focus{border-color:var(--acc);}
.ask-btn{background:var(--acc);border:none;border-radius:8px;padding:10px 20px;color:#000;font-size:12px;font-weight:700;cursor:pointer;font-family:inherit;white-space:nowrap;}
.ask-btn:disabled{opacity:.5;cursor:not-allowed;}
.loading{text-align:center;padding:40px 0;color:var(--dim);}
.loading-spinner{font-size:28px;display:inline-block;animation:spin 1s linear infinite;margin-bottom:10px;}
@keyframes spin{from{transform:rotate(0deg);}to{transform:rotate(360deg);}}
.ai-result{background:#0a1118;border:1px solid #1e3a5f;border-radius:8px;padding:20px 22px;}
.ai-result-lbl{font-size:10px;color:var(--blue);text-transform:uppercase;letter-spacing:.1em;margin-bottom:12px;}
.ai-result-txt{font-size:13px;color:var(--txt);line-height:1.8;white-space:pre-wrap;}

.footer{text-align:center;margin-top:36px;font-size:11px;color:var(--mut);border-top:1px solid var(--bdr);padding-top:18px;}
.overlay{position:fixed;inset:0;background:#00000040;z-index:199;}

@media(max-width:700px){
  .chart-row,.diag-grid,.preset-grid,.welcome-steps{grid-template-columns:1fr;}
  .raw-panel{width:100%;min-width:unset;}
  .kpi{min-width:120px;}
  .app{padding:12px;}
  .toolbar{flex-direction:column;}
  .search-input,.filter-sel{width:100%;}
  .tl-header{flex-direction:column;align-items:flex-start;}
  .kpi-row{gap:8px;}
  .day-detail-hd{flex-direction:column;}
  .header{flex-direction:column;align-items:flex-start;}
  .tabs{gap:0;}
  .tab-btn{padding:8px 12px;font-size:11px;}
}
@media(max-width:480px){
  .kpi-value{font-size:24px;}
  .logo-title{font-size:16px;}
  .page-btns .page-btn:not(.active):not(:first-child):not(:last-child){display:none;}
}
</style>
</head>
<body>
<div class="app" id="app">
  <div class="header">
    <div class="logo">
      <div class="logo-icon">âŸ</div>
      <div>
        <div class="logo-title">XSE <span>Log Analyzer</span></div>
        <div class="logo-sub">Servicio de SincronizaciÃ³n Â· Puntos de Venta Â· OXXO</div>
      </div>
    </div>
    <div style="display:flex;align-items:center;gap:10px;">
      <button onclick="toggleOwnerModal()" title="InformaciÃ³n del sistema" style="background:transparent;border:1px solid var(--bdr);border-radius:50%;width:28px;height:28px;color:var(--dim);font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;flex-shrink:0" onmouseover="this.style.borderColor='var(--acc)';this.style.color='var(--acc)'" onmouseout="this.style.borderColor='var(--bdr)';this.style.color='var(--dim)'">â“˜</button>
      <div class="status-pill">
        <div class="status-dot idle" id="status-dot"></div>
        <span class="status-text" id="status-text">Sin datos cargados</span>
      </div>
    </div>
  </div>
  <!-- Owner modal -->
  <div id="owner-modal" style="display:none;position:fixed;inset:0;z-index:500;align-items:center;justify-content:center;background:#00000070">
    <div style="background:var(--surf);border:1px solid var(--acc);border-radius:14px;padding:28px 32px;max-width:340px;width:90%;box-shadow:0 8px 40px #000000aa;position:relative;animation:slideIn .2s ease">
      <button onclick="toggleOwnerModal()" style="position:absolute;top:12px;right:14px;background:transparent;border:none;color:var(--dim);font-size:18px;cursor:pointer;line-height:1">âœ•</button>
      <div style="text-align:center;margin-bottom:16px">
        <div style="font-size:36px;margin-bottom:8px">âŸ</div>
        <div style="font-size:16px;font-weight:700;font-family:'Courier New',monospace;color:var(--acc)">XSE Log Analyzer</div>
        <div style="font-size:11px;color:var(--mut);margin-top:3px">Servicio de SincronizaciÃ³n Â· OXXO</div>
      </div>
      <div style="border-top:1px solid var(--bdr);padding-top:16px">
        <div style="font-size:10px;color:var(--mut);text-transform:uppercase;letter-spacing:.12em;margin-bottom:8px">Propietario del Sistema</div>
        <div style="font-size:15px;font-weight:700;color:var(--txt);font-family:'Segoe UI',sans-serif">Ing. Benjamin Ruiz Tadeo</div>
        <div style="font-size:11px;color:var(--dim);margin-top:4px">Todos los derechos reservados</div>
      </div>
      <div style="border-top:1px solid var(--bdr);margin-top:16px;padding-top:12px;font-size:10px;color:var(--mut);text-align:center">
        Â© ${new Date().getFullYear()} Â· Uso interno autorizado Ãºnicamente
      </div>
    </div>
  </div>

  <!-- Upload zone -->
  <div class="upload-area" id="upload-zone">
    <div class="upload-inner">
      <div class="upload-icon">ğŸ“‚</div>
      <div class="upload-texts">
        <div class="upload-main">Arrastra archivos <code>.log</code> del servicio XSE aquÃ­</div>
        <div class="upload-hint">Puedes cargar uno o varios archivos al mismo tiempo. El nombre del archivo determina el identificador de la terminal (ej: <strong style="color:var(--acc)">error_XSE_504RP_VT3.log</strong> â†’ Terminal <strong style="color:var(--acc)">VT3</strong>). Cada nueva carga reemplaza el anÃ¡lisis anterior.</div>
      </div>
      <label>
        <button class="upload-btn" onclick="this.parentElement.querySelector('input').click()">Seleccionar archivos</button>
        <input type="file" accept=".log" multiple style="display:none" id="file-input">
      </label>
    </div>
  </div>

  <!-- Validation results row -->
  <div class="val-row" id="val-row" style="display:none"></div>

  <!-- Tabs (hidden until data loaded) -->
  <div class="tabs" id="tabs" style="display:none"></div>

  <!-- Main content -->
  <div id="content"></div>

  <div class="footer" id="footer">XSE Log Analyzer Â· Desarrollado para el anÃ¡lisis de errores del servicio de sincronizaciÃ³n OXXO</div>
</div>

<script>
// â”€â”€â”€ XSE Validation fingerprints â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const XSE_SIG = {
  namespace:       /Oxxo\.Services\.XSE\./,
  entryFormat:     /Error\tEvent-900\s+\d{2}\/\d{2}\/\d{4}\s+\d{2}:\d{2}:\d{2}\.\d+\s+\(thd-\d+\)\t/,
  knownComponents: /\b(SyncDAO|StatusDAO|MachineDAO|ConfigDAO|ExecuteTaskDomain|TaskDomain|CloseTransDomain)\b/,
  xseMethodCall:   /Oxxo\.Services\.XSE\.DataAccess\.(DAO|Conn)\./,
};

function validateXSE(text) {
  // Count parseable XSE entries as a hard signal
  const entryMatches = (text.match(/Error\tEvent-900\s+\d{2}\/\d{2}\/\d{4}/g) || []).length;
  const xseNsMatches = (text.match(/Oxxo\.Services\.XSE\./g) || []).length;

  const checks = {
    formato:     { label: 'Formato de entrada  ErrorÂ·Event-900 DD/MM/YYYY (thd-N)',  ok: XSE_SIG.entryFormat.test(text) },
    namespace:   { label: 'Namespace  Oxxo.Services.XSE.*',                          ok: XSE_SIG.namespace.test(text) },
    metodo:      { label: 'Llamadas a mÃ©todos XSE  DataAccess.DAO / Conn',           ok: XSE_SIG.xseMethodCall.test(text) },
    componentes: { label: 'Componentes XSE  SyncDAO Â· MachineDAO Â· StatusDAOâ€¦',      ok: XSE_SIG.knownComponents.test(text) },
    entradas:    { label: `Entradas XSE parseables  (encontradas: ${entryMatches})`, ok: entryMatches >= 1 },
  };

  // ALL three core criteria must pass: entryFormat + namespace + xseMethodCall
  // Components and entry count add confidence but namespace+format+method is the gate
  const isValid = checks.formato.ok && checks.namespace.ok && checks.metodo.ok;
  const passed  = Object.values(checks).filter(c => c.ok).length;
  const total   = Object.keys(checks).length;
  return { checks, passed, total, isValid, entryMatches, xseNsMatches };
}

// â”€â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentEntries = [];
let currentStats   = {};
let activeTab      = "overview";
let logState = {
  search:"", fVT:"all", fComp:"all", fErr:"all",
  sortKey:"ts", sortDir:"desc", page:0, selected:null, PER_PAGE:50
};
const F = {i:0,vt:1,date:2,time:3,ts:4,thd:5,comp:6,meth:7,ec:8,ed:9,raw:10,lineNo:11};
const C = {acc:"#f0a500",red:"#e05252",teal:"#2ec4b6",blue:"#4a90d9",mut:"#5a607a",txt:"#d4d8e8",dim:"#8890aa",grn:"#4caf7d",surf:"#12151f",bdr:"#1e2235",bg:"#0b0d14"};
const PIE = [C.acc,C.teal,C.blue,C.red,"#9b5de5","#00bbf9","#f15bb5"];

// â”€â”€â”€ Error translation map â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const ERR_TRANSLATIONS = [
  {
    match: /Login failed for user/i,
    short: "âš  Fallo de autenticaciÃ³n en base de datos",
    detail: "El usuario <strong>xse.service.account</strong> no tiene permisos para conectarse a SQL Server. La cuenta de servicio existe pero fue bloqueada, su contraseÃ±a cambiÃ³, o sus permisos fueron revocados. Se requiere intervenciÃ³n del administrador de base de datos para restablecer el acceso.",
    color: "#f0a500",
    icon: "ğŸ”"
  },
  {
    match: /Error al buscar el servidor o instancia especificado|error: 26/i,
    short: "Servidor de base de datos no encontrado",
    detail: "El servicio XSE no puede localizar el servidor SQL Server en la red. Esto indica que el servidor estÃ¡ apagado, la red estÃ¡ caÃ­da, o el nombre/direcciÃ³n del servidor en la configuraciÃ³n es incorrecto.",
    color: C.red,
    icon: "ğŸ”Œ"
  },
  {
    match: /El nombre de red especificado ya no estÃ¡ disponible/i,
    short: "ConexiÃ³n de red interrumpida",
    detail: "Se perdiÃ³ la conexiÃ³n de red con el servidor de base de datos durante la operaciÃ³n. Probable causa: inestabilidad de red, timeout de la conexiÃ³n, o el servidor reiniciÃ³ inesperadamente.",
    color: C.red,
    icon: "ğŸ“¡"
  },
  {
    match: /Se agotÃ³ el tiempo de espera del semÃ¡foro/i,
    short: "Tiempo de espera agotado",
    detail: "El sistema esperÃ³ demasiado tiempo para obtener una conexiÃ³n disponible del pool de conexiones. Indica que todas las conexiones a la base de datos estÃ¡n ocupadas o bloqueadas.",
    color: "#f0a500",
    icon: "â±"
  },
  {
    match: /El identificador especificado no es vÃ¡lido/i,
    short: "Identificador de conexiÃ³n invÃ¡lido",
    detail: "El identificador interno de la conexiÃ³n a base de datos ya no es vÃ¡lido. La conexiÃ³n fue cerrada o expirÃ³ antes de completar la operaciÃ³n.",
    color: "#f0a500",
    icon: "ğŸ”‘"
  },
  {
    match: /Se ha establecido la conexiÃ³n con el servidor correctamente.*error durante el inicio de sesiÃ³n/i,
    short: "Error en handshake de inicio de sesiÃ³n",
    detail: "Se alcanzÃ³ el servidor pero fallÃ³ el proceso de autenticaciÃ³n. Posible incompatibilidad de protocolo SSL/TLS o credenciales rechazadas durante la negociaciÃ³n de conexiÃ³n.",
    color: "#f0a500",
    icon: "ğŸ¤"
  },
  {
    match: /Referencia a objeto no establecida/i,
    short: "Error interno de la aplicaciÃ³n",
    detail: "El servicio XSE intentÃ³ usar un objeto que no fue inicializado correctamente. Generalmente ocurre despuÃ©s de un fallo de conexiÃ³n previo que dejÃ³ el sistema en estado inconsistente.",
    color: C.teal,
    icon: "âš™"
  },
];

function getErrTranslation(errDesc, rawText) {
  // Check full raw text for login failed (appears inline, not in err code)
  const fullText = (errDesc || "") + " " + (rawText || "");
  for (const t of ERR_TRANSLATIONS) {
    if (t.match.test(fullText)) return t;
  }
  return null;
}

function hasLoginFailed(rawText) {
  return /Login failed for user/i.test(rawText || "");
}

function allEntries(){ return currentEntries; }
function allStats(){   return currentStats; }
const hasData = () => currentEntries.length > 0;

// â”€â”€â”€ Welcome screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderWelcome() {
  document.getElementById("tabs").style.display = "none";
  document.getElementById("content").innerHTML = `
  <div class="welcome">
    <div class="welcome-hero">
      <div class="welcome-hero-icon">ğŸ“Š</div>
      <div class="welcome-hero-title">Bienvenido al XSE Log Analyzer</div>
      <div class="welcome-hero-sub">
        Herramienta de anÃ¡lisis de errores para el servicio XSE de sincronizaciÃ³n de puntos de venta OXXO.
        Carga uno o mÃ¡s archivos <code style="color:var(--acc);background:#f0a50015;padding:1px 6px;border-radius:3px;font-family:monospace">.log</code> para comenzar.
      </div>
    </div>

    <div class="welcome-steps">
      <div class="step-card">
        <div class="step-num">1</div>
        <div class="step-title">Nombra bien tus archivos</div>
        <div class="step-body">
          El sistema detecta automÃ¡ticamente el identificador de terminal desde el nombre del archivo. Usa nombres como:<br><br>
          <code>error_XSE_VT3.log</code><br>
          <code>error_XSE_VT1.log</code><br>
          <code>error_XSE_PRO.log</code><br><br>
          El Ãºltimo segmento separado por <code>_</code> se usarÃ¡ como nombre de la terminal (ej: <code>VT3</code>, <code>PRO</code>).
        </div>
      </div>
      <div class="step-card">
        <div class="step-num">2</div>
        <div class="step-title">Carga uno o varios archivos</div>
        <div class="step-body">
          Arrastra los archivos al Ã¡rea de carga o usa el botÃ³n de selecciÃ³n. Puedes cargar varios terminales al mismo tiempo para obtener una vista comparativa.<br><br>
          âš ï¸ Cada nueva carga <strong style="color:var(--acc)">reemplaza completamente</strong> el anÃ¡lisis anterior.
        </div>
      </div>
      <div class="step-card">
        <div class="step-num">3</div>
        <div class="step-title">ValidaciÃ³n automÃ¡tica XSE</div>
        <div class="step-body">
          Cada archivo es validado contra las firmas del servicio XSE antes de procesarse. VerÃ¡s un indicador de estado por archivo con los criterios verificados.<br><br>
          Solo archivos vÃ¡lidos serÃ¡n incluidos en el anÃ¡lisis.
        </div>
      </div>
      <div class="step-card">
        <div class="step-num">4</div>
        <div class="step-title">Explora el anÃ¡lisis</div>
        <div class="step-body">
          Usa las pestaÃ±as para navegar entre:<br><br>
          â€¢ <strong style="color:var(--acc)">Vista General</strong> â€” comparativa entre terminales<br>
          â€¢ <strong style="color:var(--acc)">Terminal X</strong> â€” anÃ¡lisis individual con grÃ¡ficas<br>
          â€¢ <strong style="color:var(--acc)">Visor de Logs</strong> â€” listado filtrable con log original y nÃºmero de lÃ­nea
        </div>
      </div>
    </div>

    <div class="welcome-tips">
      <div class="tips-title">ğŸ’¡ Consejos para mejor anÃ¡lisis</div>
      <div class="tip-row"><span class="bullet">â€º</span>Carga archivos de mÃºltiples terminales juntos para obtener la vista comparativa en "Vista General".</div>
      <div class="tip-row"><span class="bullet">â€º</span>En el Visor de Logs, haz clic en cualquier fila para ver el fragmento original del log con resaltado de sintaxis.</div>
      <div class="tip-row"><span class="bullet">â€º</span>En el Visor de Logs, haz clic en cualquier fila para ver el fragmento original con resaltado de sintaxis y el nÃºmero de lÃ­nea exacto en el archivo.</div>
      <div class="tip-row"><span class="bullet">â€º</span>Los filtros por terminal, componente y cÃ³digo de error en el Visor de Logs permiten aislar incidentes especÃ­ficos.</div>
    </div>

    <div class="welcome-valid">
      <div class="valid-title">ğŸ” Firmas de validaciÃ³n del servicio XSE</div>
      <div style="font-size:11px;color:var(--dim);margin-bottom:12px;line-height:1.6;">
        El sistema verifica que los archivos cargados correspondan al servicio XSE usando estas firmas Ãºnicas:
      </div>
      <div class="sig-row"><span class="sig-label">Namespace</span><span class="sig-val">Oxxo.Services.XSE.*</span></div>
      <div class="sig-row"><span class="sig-label">Formato de entrada</span><span class="sig-val">Error\tEvent-900 DD/MM/YYYY (thd-NNN)\tâ€¦</span></div>
      <div class="sig-row"><span class="sig-label">Componentes</span><span class="sig-val">SyncDAO Â· MachineDAO Â· StatusDAO Â· ConfigDAO</span></div>
      <div class="sig-row"><span class="sig-label">Event ID</span><span class="sig-val">Event-900</span></div>
    </div>
  </div>`;
}

// â”€â”€â”€ Validation UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderValidationCards(results) {
  const row = document.getElementById("val-row");
  if(!results.length){ row.style.display="none"; return; }
  row.style.display = "flex";
  row.innerHTML = results.map(r => {
    const icon   = r.validation.isValid ? "âœ…" : "âŒ";
    const cls    = r.validation.isValid ? "valid" : "invalid";
    const stCls  = r.validation.isValid ? "ok"    : "err";
    const stTxt  = r.validation.isValid ? "ARCHIVO XSE VÃLIDO" : "ARCHIVO NO RECONOCIDO";
    const detail = r.validation.isValid
      ? `${r.entries} entradas Â· ${r.validation.passed}/${r.validation.total} firmas verificadas`
      : "Este archivo no coincide con las firmas del servicio XSE. No serÃ¡ incluido en el anÃ¡lisis.";
    const checks = Object.entries(r.validation.checks).map(([k,c]) => {
      const ck = c.ok ? "ok" : "fail";
      const ic = c.ok ? "âœ“" : "âœ—";
      return `<div class="val-check"><span class="ck ${ck}">${ic}</span><span style="color:var(--dim)">${c.label}</span></div>`;
    }).join("");
    return `<div class="val-card ${cls}">
      <div class="val-icon">${icon}</div>
      <div class="val-body">
        <div class="val-filename" title="${esc(r.filename)}">${esc(r.filename)}</div>
        <div class="val-status ${stCls}">${stTxt}</div>
        <div class="val-detail">${detail}</div>
        <div class="val-checks">${checks}</div>
      </div>
    </div>`;
  }).join("");
}

// â”€â”€â”€ Canvas Charts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawBar(id,labels,values,color){
  const cv=document.getElementById(id); if(!cv)return;
  const ctx=cv.getContext("2d");
  const W=cv.offsetWidth||cv.width; cv.width=W; cv.height=cv.offsetHeight||cv.height;
  const H=cv.height, pad={t:16,r:16,b:36,l:44};
  const cW=W-pad.l-pad.r, cH=H-pad.t-pad.b;
  ctx.clearRect(0,0,W,H);
  if(!values.length)return;
  const max=Math.max(...values,1), bW=Math.max(2,cW/values.length*0.7), step=cW/values.length;
  ctx.strokeStyle=C.bdr; ctx.lineWidth=1;
  for(let i=0;i<=4;i++){
    const y=pad.t+cH*(1-i/4);
    ctx.beginPath();ctx.moveTo(pad.l,y);ctx.lineTo(W-pad.r,y);ctx.stroke();
    ctx.fillStyle=C.mut;ctx.font="10px monospace";ctx.textAlign="right";
    ctx.fillText(Math.round(max*i/4),pad.l-4,y+4);
  }
  values.forEach((v,i)=>{
    const x=pad.l+step*i+step/2-bW/2, bH=(v/max)*cH, y=pad.t+cH-bH;
    ctx.fillStyle=color;
    ctx.beginPath(); if(ctx.roundRect)ctx.roundRect(x,y,bW,bH,2);else ctx.rect(x,y,bW,bH); ctx.fill();
    if(labels[i]&&values.length<=20){
      ctx.fillStyle=C.mut;ctx.font="9px sans-serif";ctx.textAlign="center";
      ctx.fillText((labels[i].length>6?labels[i].slice(0,6):labels[i]),x+bW/2,H-pad.b+12);
    }
  });
}
// Enhanced bar chart for overview â€” shows error count + date range per terminal
function drawBarMeta(id, meta){
  const cv=document.getElementById(id); if(!cv)return;
  const ctx=cv.getContext("2d");
  const W=cv.offsetWidth||cv.width; cv.width=W; cv.height=cv.offsetHeight||cv.height;
  const H=cv.height;
  const pad={t:36,r:20,b:56,l:50};
  const cW=W-pad.l-pad.r, cH=H-pad.t-pad.b;
  ctx.clearRect(0,0,W,H);
  if(!meta.length)return;
  const values=meta.map(m=>m.total);
  const max=Math.max(...values,1);
  const n=meta.length;
  const step=cW/n;
  const bW=Math.min(80, Math.max(30, step*0.65));

  // Grid lines
  ctx.strokeStyle=C.bdr; ctx.lineWidth=1;
  for(let i=0;i<=4;i++){
    const y=pad.t+cH*(1-i/4);
    ctx.beginPath();ctx.moveTo(pad.l,y);ctx.lineTo(W-pad.r,y);ctx.stroke();
    ctx.fillStyle=C.mut;ctx.font="10px monospace";ctx.textAlign="right";
    ctx.fillText(Math.round(max*i/4),pad.l-5,y+4);
  }

  meta.forEach((m,i)=>{
    const x=pad.l+step*i+step/2-bW/2;
    const bH=Math.max(2,(m.total/max)*cH);
    const y=pad.t+cH-bH;

    // Bar
    ctx.fillStyle=C.acc; ctx.globalAlpha=0.9;
    ctx.beginPath();
    if(ctx.roundRect)ctx.roundRect(x,y,bW,bH,3);else ctx.rect(x,y,bW,bH);
    ctx.fill(); ctx.globalAlpha=1;

    // Error count above bar
    ctx.fillStyle=C.acc; ctx.font="bold 11px monospace"; ctx.textAlign="center";
    ctx.fillText(m.total.toLocaleString(), x+bW/2, y-4);

    // Terminal name below bar
    ctx.fillStyle="#e0e4f0"; ctx.font="bold 11px sans-serif"; ctx.textAlign="center";
    ctx.fillText(m.name, x+bW/2, H-pad.b+14);

    // Date range below name (2 lines)
    ctx.fillStyle=C.teal; ctx.font="9px monospace"; ctx.textAlign="center";
    ctx.fillText(m.d1, x+bW/2, H-pad.b+26);
    ctx.fillStyle=C.dim; ctx.font="9px monospace";
    ctx.fillText(m.d2, x+bW/2, H-pad.b+38);

    // Days badge inside/above bar if tall enough
    if(bH>22){
      ctx.fillStyle="#00000055"; ctx.font="9px monospace"; ctx.textAlign="center";
      ctx.fillText(`${m.numDays}d`, x+bW/2, y+bH/2+4);
    }
  });
}

function drawHBar(id,labels,values,color){
  const cv=document.getElementById(id); if(!cv)return;
  const ctx=cv.getContext("2d");
  const W=cv.offsetWidth||cv.width; cv.width=W; cv.height=cv.offsetHeight||cv.height;
  const H=cv.height, lW=170, pad={t:8,r:24,b:8,l:lW};
  const cW=W-pad.l-pad.r, cH=H-pad.t-pad.b;
  ctx.clearRect(0,0,W,H);
  if(!values.length)return;
  const max=Math.max(...values,1), bH=Math.max(4,cH/values.length*0.55), step=cH/values.length;
  values.forEach((v,i)=>{
    const y=pad.t+step*i+step/2-bH/2, bw=(v/max)*cW;
    ctx.fillStyle=color+"44"; ctx.fillRect(pad.l,y,cW,bH);
    ctx.fillStyle=color;
    ctx.beginPath(); if(ctx.roundRect)ctx.roundRect(pad.l,y,bw,bH,2);else ctx.rect(pad.l,y,bw,bH); ctx.fill();
    ctx.fillStyle=C.dim;ctx.font="10px sans-serif";ctx.textAlign="right";
    const s=labels[i]||"", sh=s.length>26?s.slice(0,26)+"â€¦":s;
    ctx.fillText(sh,pad.l-6,y+bH/2+4);
    ctx.fillStyle=C.mut;ctx.font="10px monospace";ctx.textAlign="left";
    ctx.fillText(v,pad.l+bw+4,y+bH/2+4);
  });
}
function drawPie(id,labels,values){
  const cv=document.getElementById(id); if(!cv)return;
  const ctx=cv.getContext("2d");
  const W=cv.offsetWidth||cv.width; cv.width=W; cv.height=cv.offsetHeight||cv.height;
  const H=cv.height; ctx.clearRect(0,0,W,H);
  const total=values.reduce((a,b)=>a+b,0); if(!total)return;
  const cx=W*0.4, cy=H/2, r=Math.min(cx,cy)-20;
  let sa=-Math.PI/2;
  values.forEach((v,i)=>{
    const sl=(v/total)*Math.PI*2;
    ctx.beginPath();ctx.moveTo(cx,cy);ctx.arc(cx,cy,r,sa,sa+sl);ctx.closePath();
    ctx.fillStyle=PIE[i%PIE.length];ctx.fill();
    if(v/total>0.04){
      const ma=sa+sl/2, lx=cx+Math.cos(ma)*(r*.65), ly=cy+Math.sin(ma)*(r*.65);
      ctx.fillStyle="#000";ctx.font="bold 10px sans-serif";ctx.textAlign="center";
      ctx.fillText(Math.round(v/total*100)+"%",lx,ly+4);
    }
    sa+=sl;
  });
  const legX=W*.8, legY=H/2-(labels.length*18)/2;
  labels.forEach((l,i)=>{
    const y=legY+i*18;
    ctx.fillStyle=PIE[i%PIE.length];ctx.fillRect(legX,y,10,10);
    ctx.fillStyle=C.dim;ctx.font="10px sans-serif";ctx.textAlign="left";
    ctx.fillText(l.length>14?l.slice(0,14)+"â€¦":l,legX+14,y+9);
  });
}

// â”€â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function esc(s){return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");}
function ecColor(ec){return ec==="26"?C.red:ec==="0"?C.teal:C.acc;}
function ecTag(ec){const cls=ec==="26"?"tag-sql26":ec==="0"?"tag-app":"tag-other",lbl=ec!=="0"?`SQL-${ec}`:"App";return `<span class="tag ${cls}">${lbl}</span>`;}
function sortArrow(col){if(logState.sortKey!==col)return"<span style='color:var(--mut);margin-left:4px;font-size:10px'>â†•</span>";return`<span style='color:var(--acc);margin-left:4px;font-size:10px'>${logState.sortDir==="asc"?"â†‘":"â†“"}</span>`;}
function parseDate(s){const[d,m,y]=s.split("/");return new Date(+y,+m-1,+d);}
function fmtDate(dt){
  return dt.toLocaleDateString("es-MX",{day:"2-digit",month:"2-digit",year:"numeric"});
}
function fmtDateShort(dt){
  return dt.toLocaleDateString("es-MX",{day:"2-digit",month:"2-digit"});
}

// â”€â”€â”€ Timeline aggregation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Returns [{key, label, shortLabel, count, days:[{date,count}]}]
function aggregateDays(dc){
  return Object.entries(dc)
    .sort((a,b)=>parseDate(a[0])-parseDate(b[0]))
    .map(([date,count])=>({
      key:date, label:date,
      shortLabel: date.slice(0,5),  // DD/MM
      count, days:[{date,count}]
    }));
}
function aggregateWeeks(dc){
  const sorted=Object.entries(dc).sort((a,b)=>parseDate(a[0])-parseDate(b[0]));
  const weeks=[];
  sorted.forEach(([date,count])=>{
    const dt=parseDate(date);
    const mon=new Date(dt); mon.setDate(dt.getDate()-((dt.getDay()+6)%7));
    const wkey=`${String(mon.getDate()).padStart(2,"0")}/${String(mon.getMonth()+1).padStart(2,"0")}/${mon.getFullYear()}`;
    let w=weeks.find(x=>x.key===wkey);
    if(!w){
      const sun=new Date(mon); sun.setDate(mon.getDate()+6);
      w={key:wkey, label:`${fmtDate(mon)} â€“ ${fmtDate(sun)}`,
         shortLabel:`${fmtDateShort(mon)}-${fmtDateShort(sun)}`, count:0, days:[]};
      weeks.push(w);
    }
    w.count+=count; w.days.push({date,count});
  });
  return weeks;
}
function aggregateMonths(dc){
  const sorted=Object.entries(dc).sort((a,b)=>parseDate(a[0])-parseDate(b[0]));
  const months=[];
  const MNAMES=["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"];
  sorted.forEach(([date,count])=>{
    const [d,m,y]=date.split("/");
    const mkey=`${m}/${y}`;
    let mo=months.find(x=>x.key===mkey);
    if(!mo){
      mo={key:mkey, label:`${MNAMES[+m-1]} ${y}`, shortLabel:`${MNAMES[+m-1]} ${y.slice(2)}`, count:0, days:[]};
      months.push(mo);
    }
    mo.count+=count; mo.days.push({date,count});
  });
  return months;
}

// â”€â”€â”€ Timeline state (keyed by terminal name) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const tlState={};
function getTlState(name){
  if(!tlState[name]) tlState[name]={gran:"day",selectedIdx:null,daysLimit:0};
  return tlState[name];
}

// â”€â”€â”€ Interactive timeline chart â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const tlBarMeta={};  // stores bar hit areas per canvas id
const tlHoverState={}; // tracks hovered bar per canvas id

function drawTimeline(id, buckets, selectedIdx, hoverIdx){
  const cv=document.getElementById(id); if(!cv)return;
  const ctx=cv.getContext("2d");
  const W=cv.offsetWidth||cv.width; cv.width=W; cv.height=cv.offsetHeight||cv.height;
  const H=cv.height;
  const pad={t:20,r:16,b:44,l:44};
  const cW=W-pad.l-pad.r, cH=H-pad.t-pad.b;
  ctx.clearRect(0,0,W,H);
  if(!buckets.length)return;

  const values=buckets.map(b=>b.count);
  const max=Math.max(...values,1);
  const n=buckets.length;
  const step=cW/n;
  const bW=Math.max(2,step*0.68);

  // Grid lines + Y labels
  ctx.strokeStyle=C.bdr; ctx.lineWidth=1;
  for(let i=0;i<=4;i++){
    const y=pad.t+cH*(1-i/4);
    ctx.beginPath();ctx.moveTo(pad.l,y);ctx.lineTo(W-pad.r,y);ctx.stroke();
    ctx.fillStyle=C.mut;ctx.font="10px monospace";ctx.textAlign="right";
    ctx.fillText(Math.round(max*i/4),pad.l-5,y+4);
  }

  // Bars
  tlBarMeta[id]=[];
  buckets.forEach((b,i)=>{
    const x=pad.l+step*i+step/2-bW/2;
    const bH=Math.max(2,(b.count/max)*cH);
    const y=pad.t+cH-bH;
    const isSelected=(i===selectedIdx);
    const isHov=(i===hoverIdx);

    // Bar fill
    ctx.fillStyle=isSelected?"#fff":isHov?"#ffc642":C.acc;
    ctx.globalAlpha=isSelected?1:isHov?1:0.85;
    ctx.beginPath();
    if(ctx.roundRect)ctx.roundRect(x,y,bW,bH,3);else ctx.rect(x,y,bW,bH);
    ctx.fill();
    ctx.globalAlpha=1;

    // Selected or hover: label above bar
    if(isSelected||isHov){
      if(isSelected){
        ctx.strokeStyle=C.acc;ctx.lineWidth=2;
        ctx.beginPath();
        if(ctx.roundRect)ctx.roundRect(x-1,y-1,bW+2,bH+2,3);else ctx.rect(x-1,y-1,bW+2,bH+2);
        ctx.stroke();
      }
      // Full date label above bar
      const labelColor=isSelected?C.acc:"#ffd066";
      ctx.fillStyle=labelColor;ctx.font="bold 11px monospace";ctx.textAlign="center";
      ctx.fillText(b.count,x+bW/2,y-18);
      // Show full date label
      ctx.font="bold 10px monospace";
      ctx.fillText(b.label,x+bW/2,y-6);
    }

    // X-axis label
    if(n<=30){
      ctx.fillStyle=isSelected?"#fff":isHov?"#ffd066":"#c8cedd";
      ctx.font="bold 9px sans-serif";
      ctx.textAlign="center";
      ctx.save();
      ctx.translate(x+bW/2, H-pad.b+6);
      if(n>14) ctx.rotate(-Math.PI/4);
      ctx.fillText(b.shortLabel,0,0);
      ctx.restore();
    } else {
      const nth=Math.ceil(n/20);
      if(i%nth===0){
        ctx.fillStyle="#c8cedd";ctx.font="bold 9px sans-serif";ctx.textAlign="center";
        ctx.save();
        ctx.translate(x+bW/2,H-pad.b+6);
        ctx.rotate(-Math.PI/4);
        ctx.fillText(b.shortLabel,0,0);
        ctx.restore();
      }
    }

    // Store hit area
    tlBarMeta[id].push({x,y:pad.t,w:bW,h:cH,idx:i});
  });

  // Cursor line for selected
  if(selectedIdx!==null&&selectedIdx>=0&&selectedIdx<buckets.length){
    const b=tlBarMeta[id][selectedIdx];
    const cx=b.x+bW/2;
    ctx.strokeStyle=C.acc+"88";ctx.lineWidth=1;ctx.setLineDash([3,3]);
    ctx.beginPath();ctx.moveTo(cx,pad.t);ctx.lineTo(cx,pad.t+cH);ctx.stroke();
    ctx.setLineDash([]);
  }
}

function tlCanvasClick(evt, terminalName){
  const cv=evt.target;
  const rect=cv.getBoundingClientRect();
  const mx=(evt.clientX-rect.left)*(cv.width/rect.width);
  const my=(evt.clientY-rect.top)*(cv.height/rect.height);
  const meta=tlBarMeta[cv.id]; if(!meta)return;
  const hit=meta.find(b=>mx>=b.x&&mx<=b.x+b.w&&my>=b.y&&my<=b.y+b.h);
  const st=getTlState(terminalName);
  if(hit){
    st.selectedIdx=(st.selectedIdx===hit.idx?null:hit.idx);
  } else {
    st.selectedIdx=null;
  }
  refreshTimeline(terminalName);
}

function tlCanvasMousemove(evt, terminalName){
  const cv=evt.target;
  const rect=cv.getBoundingClientRect();
  const mx=(evt.clientX-rect.left)*(cv.width/rect.width);
  const my=(evt.clientY-rect.top)*(cv.height/rect.height);
  const meta=tlBarMeta[cv.id]; if(!meta)return;
  const hit=meta.find(b=>mx>=b.x&&mx<=b.x+b.w&&my>=b.y&&my<=b.y+b.h);
  const prevHover=tlHoverState[cv.id];
  const newHover=hit?hit.idx:null;
  if(prevHover===newHover)return;
  tlHoverState[cv.id]=newHover;
  cv.style.cursor=hit?"pointer":"default";
  // Redraw with hover highlight
  const st=getTlState(terminalName);
  const data=allStats()[terminalName]; if(!data)return;
  const buckets=getBuckets(data.day_counts, st.gran, st.daysLimit);
  drawTimeline(cv.id, buckets, st.selectedIdx, newHover);
}

function tlCanvasMouseleave(evt, terminalName){
  const cv=evt.target;
  tlHoverState[cv.id]=null;
  const st=getTlState(terminalName);
  const data=allStats()[terminalName]; if(!data)return;
  const buckets=getBuckets(data.day_counts, st.gran, st.daysLimit);
  drawTimeline(cv.id, buckets, st.selectedIdx, null);
}

// â”€â”€â”€ Days limit slider â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setTlDaysLimit(terminalName, val){
  const st=getTlState(terminalName);
  st.daysLimit=+val; st.selectedIdx=null;
  refreshTimeline(terminalName);
}

// â”€â”€â”€ Granularity selector â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setTlGran(terminalName, gran){
  const st=getTlState(terminalName);
  st.gran=gran; st.selectedIdx=null;
  refreshTimeline(terminalName);
}

function getBuckets(dc, gran, daysLimit){
  let days = aggregateDays(dc);
  // Apply days limit (trim from the beginning, keep latest N days)
  if(daysLimit && daysLimit > 0 && days.length > daysLimit){
    days = days.slice(days.length - daysLimit);
    // Rebuild a limited dc
    const limitedDc = {};
    days.forEach(d => limitedDc[d.key] = d.count);
    dc = limitedDc;
  }
  if(gran==="week") return aggregateWeeks(dc);
  if(gran==="month") return aggregateMonths(dc);
  return days;
}

// â”€â”€â”€ Build day-detail HTML â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildDayDetail(terminalName, bucket){
  const entries=allEntries().filter(e=>e[F.vt]===terminalName&&bucket.days.some(d=>d.date===e[F.date]));
  if(!entries.length) return "";

  // Component breakdown chips
  const compMap={};
  entries.forEach(e=>{compMap[e[F.comp]]=(compMap[e[F.comp]]||0)+1;});
  const chips=Object.entries(compMap).sort((a,b)=>b[1]-a[1]).map(([k,v])=>
    `<span class="day-chip" style="background:${C.blue}22;color:${C.blue};border-color:${C.blue}44">${esc(k)} <strong>${v}</strong></span>`
  ).join("");

  // Error type chips
  const ecMap={};
  entries.forEach(e=>{const lbl=e[F.ec]==="login"?"AUTH":e[F.ec]!=="0"?`SQL-${e[F.ec]}`:"App";ecMap[lbl]=(ecMap[lbl]||0)+1;});
  const ecChips=Object.entries(ecMap).sort((a,b)=>b[1]-a[1]).map(([k,v])=>{
    const col=k.includes("26")?C.red:k==="AUTH"?C.acc:C.teal;
    return `<span class="day-chip" style="background:${col}22;color:${col};border-color:${col}44">${esc(k)} <strong>${v}</strong></span>`;
  }).join("");

  // Sort entries by timestamp desc
  const sorted=[...entries].sort((a,b)=>b[F.ts]>a[F.ts]?1:-1);
  const rows=sorted.slice(0,200).map(e=>`
    <tr onclick="openEntryDetail(${e[F.i]})">
      <td style="color:var(--teal);font-family:monospace;white-space:nowrap;font-weight:600">${esc(e[F.date])}</td>
      <td style="color:var(--mut);font-family:monospace;white-space:nowrap">${esc(e[F.time]).slice(0,8)}</td>
      <td style="color:var(--blue);font-family:monospace">${esc(e[F.comp])}</td>
      <td style="max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${esc(e[F.meth])}">${esc(e[F.meth])}</td>
      <td>${ecTag(e[F.ec])}</td>
      <td style="color:var(--dim);max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${esc(e[F.ed])}">${esc(e[F.ed])}</td>
    </tr>`).join("");

  return `<div class="day-detail" id="day-detail-panel">
    <div class="day-detail-hd">
      <div class="day-detail-date">${esc(bucket.label)}</div>
      <div class="day-detail-stats">
        <span class="day-detail-stat">Errores: <strong style="color:${C.red}">${entries.length}</strong></span>
        ${bucket.days.length>1?`<span class="day-detail-stat">DÃ­as: <strong>${bucket.days.length}</strong></span>`:""}
        <span class="day-detail-stat" style="color:var(--mut);font-size:10px">Clic en fila para ver detalle</span>
      </div>
      <button class="day-detail-close" onclick="closeTlDetail('${terminalName}')">âœ• Cerrar</button>
    </div>
    <div class="day-chips">${chips}${ecChips}</div>
    <div class="day-table-wrap">
      <table class="day-table">
        <thead><tr><th>Fecha</th><th>Hora</th><th>Componente</th><th>MÃ©todo</th><th>CÃ³digo</th><th>DescripciÃ³n</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>
    </div>
    ${entries.length>200?`<div style="padding:8px 16px;font-size:10px;color:var(--mut);border-top:1px solid var(--bdr)">Mostrando primeros 200 de ${entries.length} errores</div>`:""}
  </div>
  <div id="tl-raw-panel-container"></div>`;
}

// â”€â”€â”€ Refresh only the timeline section (no full re-render) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function refreshTimeline(terminalName){
  const data=allStats()[terminalName]; if(!data)return;
  const st=getTlState(terminalName);
  const allDays=Object.keys(data.day_counts).length;
  const buckets=getBuckets(data.day_counts, st.gran, st.daysLimit);
  const numDays=Object.keys(data.day_counts).length;

  // Update granularity buttons (removed â€” no longer shown)

  // Update days slider label
  const sliderLabel=document.getElementById("tl-days-label");
  if(sliderLabel){
    const lim=st.daysLimit||allDays;
    sliderLabel.textContent=`Ãšltimos ${Math.min(lim,allDays)} dÃ­as`;
  }

  // Redraw chart
  const cv=document.getElementById("chart-tl");
  if(cv){
    const newH=Math.max(180, Math.min(280, 180+buckets.length));
    cv.style.height=newH+"px";
    drawTimeline("chart-tl", buckets, st.selectedIdx, tlHoverState["chart-tl"]||null);
  }

  // Update period label â€” compute actual date+time range from entries
  const periodEl=document.getElementById("tl-period-label");
  if(periodEl){
    const termEntries=allEntries().filter(e=>e[F.vt]===terminalName);
    if(termEntries.length){
      const sortedE=[...termEntries].sort((a,b)=>(a[F.ts]<b[F.ts]?-1:a[F.ts]>b[F.ts]?1:0));
      const first=sortedE[0], last=sortedE[sortedE.length-1];
      const d1=first[F.date], t1=first[F.time].slice(0,8);
      const d2=last[F.date],  t2=last[F.time].slice(0,8);
      periodEl.innerHTML=`<span style="color:var(--teal)">${d1}</span> <span style="color:var(--dim)">${t1}</span> <span style="color:var(--mut)">â†’</span> <span style="color:var(--teal)">${d2}</span> <span style="color:var(--dim)">${t2}</span> <span style="color:var(--mut)">Â·  ${numDays} dÃ­a${numDays!==1?"s":""}</span>`;
    } else if(data.date_range){
      periodEl.textContent=`${data.date_range[0]} â†’ ${data.date_range[1]}  Â·  ${numDays} dÃ­a${numDays!==1?"s":""}`;
    }
  }

  // Day detail
  const container=document.getElementById("tl-detail-container");
  if(container){
    if(st.selectedIdx!==null&&buckets[st.selectedIdx]){
      container.innerHTML=buildDayDetail(terminalName, buckets[st.selectedIdx]);
    } else {
      container.innerHTML="";
    }
  }
}

function closeTlDetail(terminalName){
  getTlState(terminalName).selectedIdx=null;
  refreshTimeline(terminalName);
}

// â”€â”€â”€ Open entry detail inline (without switching tab) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let tlSelectedEntry = null;
function openEntryDetail(id){
  tlSelectedEntry = (tlSelectedEntry === id ? null : id);
  const container = document.getElementById("tl-raw-panel-container");
  if(!container) return;
  if(tlSelectedEntry === null){ container.innerHTML=""; return; }
  const e = allEntries().find(x=>x[F.i]===id);
  if(!e){ container.innerHTML=""; return; }
  container.innerHTML = `<div style="margin-top:12px;position:relative">` + renderRawPanelInline(e) + `</div>`;
}
function closeTlEntryDetail(){
  tlSelectedEntry = null;
  const c = document.getElementById("tl-raw-panel-container");
  if(c) c.innerHTML="";
}
function renderRawPanelInline(e){
  const ec=e[F.ec], color=ecColor(ec);
  const lineNo=e[F.lineNo]||"?";
  const rawText=e[F.raw]||"";
  const loginFlag=hasLoginFailed(rawText);
  const trans=getErrTranslation(e[F.ed], rawText);
  const loginTrans=ERR_TRANSLATIONS[0];
  const loginAlert=loginFlag?`
    <div style="background:#1a1000;border:1px solid #f0a50066;border-left:3px solid #f0a500;border-radius:6px;padding:10px 14px;margin-top:8px;">
      <div style="font-size:10px;color:#f0a500;text-transform:uppercase;letter-spacing:.1em;margin-bottom:4px">ğŸ” Fallo de autenticaciÃ³n detectado</div>
      <div style="font-size:11px;color:var(--dim);line-height:1.6">La cuenta <strong style="color:#f0a500;font-family:monospace">xse.service.account</strong> fue rechazada.</div>
    </div>`:"";
  const ecLabel = ec==="login"?"Auth Error":ec!=="0"?`SQL Error ${ec}`:"App Error";
  return `<div style="background:var(--surf);border:1px solid var(--bdr);border-left:3px solid ${color};border-radius:8px;overflow:hidden">
    <div style="padding:12px 16px;border-bottom:1px solid var(--bdr);background:#0d1018;display:flex;justify-content:space-between;align-items:flex-start;gap:12px;flex-wrap:wrap">
      <div style="flex:1;min-width:0">
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:6px">
          <span style="font-size:10px;border-radius:4px;padding:2px 8px;font-family:monospace;background:${color}22;color:${color};border:1px solid ${color}44">${ecLabel}</span>
          <span style="font-size:10px;color:var(--mut);font-family:monospace">${esc(e[F.vt])} Â· thd-${esc(e[F.thd])}</span>
          <span style="font-size:10px;background:#2ec4b622;color:var(--teal);border:1px solid #2ec4b644;border-radius:4px;padding:2px 8px;font-family:monospace">LÃ­nea ${lineNo}</span>
        </div>
        <div style="font-family:monospace;font-size:13px;color:var(--txt);font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(e[F.meth])}</div>
        <div style="font-size:11px;margin-top:4px"><span style="color:var(--teal);font-family:monospace;font-weight:600">${esc(e[F.date])}</span><span style="color:var(--dim);font-family:monospace;margin-left:8px">${esc(e[F.time])}</span></div>
      </div>
      <button onclick="closeTlEntryDetail()" style="background:transparent;border:1px solid var(--bdr);border-radius:6px;color:var(--dim);font-size:16px;cursor:pointer;padding:4px 10px;line-height:1;flex-shrink:0">âœ•</button>
    </div>
    <div style="padding:10px 16px;border-bottom:1px solid var(--bdr);display:flex;flex-wrap:wrap;gap:8px">
      ${[["Terminal",e[F.vt],C.acc],["Componente",e[F.comp],C.teal],["CÃ³digo",ec==="login"?"AUTH":ec!=="0"?`SQL-${ec}`:"App",color],["Thread",`thd-${e[F.thd]}`,C.blue]].map(([l,v,c])=>`<div style="border-radius:6px;padding:4px 10px;border:1px solid ${c}33;background:${c}18"><div style="font-size:9px;color:var(--mut);text-transform:uppercase;letter-spacing:.1em">${l}</div><div style="font-size:12px;font-family:monospace;font-weight:600;color:${c}">${esc(v)}</div></div>`).join("")}
    </div>
    <div style="padding:10px 16px;border-bottom:1px solid var(--bdr);background:#0f0a00">
      <div style="font-size:10px;color:var(--acc);text-transform:uppercase;letter-spacing:.1em;margin-bottom:4px">DescripciÃ³n del Error</div>
      <div style="font-size:12px;color:#f5c842;font-family:monospace;line-height:1.5">${esc(e[F.ed])}</div>
      ${trans&&!loginFlag?`<div style="font-size:11px;color:var(--dim);line-height:1.6;background:#ffffff08;border-radius:5px;padding:8px 10px;margin-top:8px">${trans.icon} <strong style="color:${trans.color}">${trans.short}:</strong> ${trans.detail}</div>`:""}
      ${loginAlert}
    </div>
    <div style="padding:9px 16px;border-bottom:1px solid var(--bdr);display:flex;justify-content:space-between;align-items:center">
      <div style="font-size:10px;color:var(--mut);text-transform:uppercase;letter-spacing:.1em">Fragmento Original Â· LÃ­nea ${lineNo}</div>
    </div>
    <div style="padding:14px 16px;max-height:260px;overflow-y:auto"><pre style="margin:0;font-size:11px;line-height:1.8;font-family:'Courier New',monospace;color:var(--dim);white-space:pre-wrap;word-break:break-all">${hlRaw(rawText)}</pre></div>
  </div>`;
}



function hlRaw(raw){
  return esc(raw)
    .replace(/(Error\tEvent-\d+)/g,'<span style="color:#e05252;font-weight:700">$1</span>')
    .replace(/(\d{2}\/\d{2}\/\d{4}\s+\d{2}:\d{2}:\d{2}[\.\d]*)/g,'<span style="color:#2ec4b6">$1</span>')
    .replace(/(\(thd-\d+\))/g,'<span style="color:#9b5de5">$1</span>')
    .replace(/(error: \d+ - [^\n]+)/gi,'<span style="color:#f0a500;font-weight:600">$1</span>')
    .replace(/(Stack trace:)/g,'<span style="color:#4a90d9;font-weight:600">$1</span>')
    .replace(/(en Oxxo\.[^\n]+)/g,'<span style="color:#4caf7d">$1</span>')
    .replace(/(en System\.[^\n]+)/g,'<span style="color:#5a607a">$1</span>')
    .replace(/(Error Fatal[^,\n]*)/g,'<span style="color:#e05252">$1</span>')
    .replace(/\t/g,"    ");
}

// â”€â”€â”€ Tab renderers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderOverview(){
  const stats=allStats(), total=Object.values(stats).reduce((s,d)=>s+d.total,0);
  const allM={},allE={};
  Object.values(stats).forEach(d=>{
    Object.entries(d.method_counts).forEach(([k,v])=>allM[k]=(allM[k]||0)+v);
    Object.entries(d.err_counts).forEach(([k,v])=>allE[k]=(allE[k]||0)+v);
  });
  const cmpL=Object.keys(stats),cmpV=Object.values(stats).map(d=>d.total);
  // Build per-terminal day-range metadata for chart labels
  const cmpMeta=Object.entries(stats).map(([name,d])=>{
    const entries=allEntries().filter(e=>e[F.vt]===name);
    let d1=d.date_range[0]||"?", d2=d.date_range[1]||"?";
    if(entries.length){
      const sorted=[...entries].sort((a,b)=>(a[F.ts]<b[F.ts]?-1:a[F.ts]>b[F.ts]?1:0));
      d1=sorted[0][F.date]; d2=sorted[sorted.length-1][F.date];
    }
    const numDays=Object.keys(d.day_counts).length;
    return{name,total:d.total,d1,d2,numDays};
  });
  const topM=Object.entries(allM).sort((a,b)=>b[1]-a[1]).slice(0,8);
  const errE=Object.entries(allE).sort((a,b)=>b[1]-a[1]);
  const errT=errE.reduce((s,[,v])=>s+v,0);
  document.getElementById("content").innerHTML=`
  <div class="kpi-row">
    <div class="kpi"><div class="kpi-label">Total Global</div><div class="kpi-value" style="color:${C.red}">${total.toLocaleString()}</div><div class="kpi-sub">errores en todos los terminales</div></div>
    <div class="kpi"><div class="kpi-label">Terminales</div><div class="kpi-value" style="color:${C.acc}">${Object.keys(stats).length}</div><div class="kpi-sub">analizados</div></div>
    <div class="kpi"><div class="kpi-label">Error Dominante</div><div class="kpi-value" style="color:${C.teal};font-size:22px">SQL-26</div><div class="kpi-sub">Servidor no encontrado</div></div>
    <div class="kpi"><div class="kpi-label">Servicio</div><div class="kpi-value" style="color:${C.blue};font-size:22px">XSE</div><div class="kpi-sub">SincronizaciÃ³n POS</div></div>
  </div>
  <div class="sec-title">Errores por Terminal</div>
  <div class="chart-box"><canvas id="chart-cmp" style="width:100%;height:240px"></canvas></div>
  <div class="sec-title">Desglose de Errores SQL</div>
  <div class="err-table"><table>
    <thead><tr><th>DescripciÃ³n del Error</th><th style="text-align:right">Ocurrencias</th><th style="text-align:right">%</th></tr></thead>
    <tbody>${errE.map(([err,cnt])=>`<tr><td style="font-family:monospace;font-size:11px;color:var(--txt)">${esc(err)}</td><td style="color:var(--red);text-align:right;font-family:monospace;font-weight:700">${cnt}</td><td style="text-align:right"><span class="progress-bar"><span class="progress-fill" style="width:${Math.round(cnt/errT*100)}%"></span></span><span style="color:var(--dim);font-size:11px">${(cnt/errT*100).toFixed(1)}%</span></td></tr>`).join("")}</tbody>
  </table></div>
  <div class="sec-title">DiagnÃ³stico AutomÃ¡tico</div>
  <div class="diag-grid">
    ${[
      {icon:"ğŸ”Œ",title:"Conectividad SQL Server",sev:C.red,msg:"El error SQL-26 representa >95% de todos los fallos. El servicio XSE no puede alcanzar la instancia de SQL Server. Posibles causas: red caÃ­da, instancia SQL detenida o nombre de instancia incorrecto en configuraciÃ³n."},
      {icon:"ğŸ”„",title:"Impacto en SincronizaciÃ³n",sev:C.acc,msg:"SyncDAO.GetTaskToProcess y GetTaskForMov18Quantity concentran el mayor volumen, bloqueando la actualizaciÃ³n de precios y movimientos de inventario en los puntos de venta."},
      {icon:"ğŸ“¡",title:"Concurrencia de Hilos",sev:C.teal,msg:"MÃºltiples threads reportan fallos simultÃ¡neos, indicando un problema sistÃ©mico. Todo el pool de conexiones SQL queda bloqueado, impidiendo cualquier operaciÃ³n de sincronizaciÃ³n."},
      {icon:"ğŸ“…",title:"PatrÃ³n Temporal",sev:C.blue,msg:"Analiza los picos de error en la lÃ­nea de tiempo por terminal para identificar ventanas de mantenimiento fallidas o incidentes recurrentes."},
    ].map(d=>`<div class="diag-card" style="border-left:3px solid ${d.sev}"><div class="diag-card-hd"><span style="font-size:18px">${d.icon}</span><span style="font-size:12px;font-weight:600;color:${d.sev}">${d.title}</span></div><div class="diag-card-msg">${d.msg}</div></div>`).join("")}
  </div>`;
  setTimeout(()=>{
    drawBarMeta("chart-cmp", cmpMeta);
  },0);
}

function renderTerminal(name){
  const data=allStats()[name]; if(!data)return;
  const sev=data.total>1000?{l:"CRÃTICO",c:C.red}:data.total>100?{l:"ALTO",c:C.acc}:{l:"MEDIO",c:C.teal};
  const topErr=Object.entries(data.err_counts)[0];
  const tl=aggregateDays(data.day_counts); // kept for compatibility
  const topM=Object.entries(data.method_counts).slice(0,8);
  const compE=Object.entries(data.comp_counts), errE=Object.entries(data.err_counts);
  const errT=errE.reduce((s,[,v])=>s+v,0);
  const loginCnt = data.err_counts["Login failed for user 'xse.service.account'."] || 0;

  function buildErrBanners() {
    if (!topErr) return "";
    const [errKey, cnt] = topErr;
    const trans = getErrTranslation(errKey, errKey);
    const loginTrans = ERR_TRANSLATIONS[0];
    let html = "";
    if (trans) {
      html += `<div style="background:#1a0f0f;border:1px solid ${trans.color}44;border-left:4px solid ${trans.color};border-radius:8px;padding:16px 18px;margin:20px 0;">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;flex-wrap:wrap;">
          <span style="font-size:22px">${trans.icon}</span>
          <div style="flex:1;min-width:0;">
            <div style="font-size:10px;color:${trans.color};text-transform:uppercase;letter-spacing:.12em;margin-bottom:3px">Error Dominante</div>
            <div style="font-family:monospace;font-size:12px;color:var(--txt);font-weight:600;word-break:break-all">${esc(errKey)}</div>
          </div>
          <span style="font-size:11px;color:var(--dim);flex-shrink:0;">Ocurrencias: <strong style="color:${trans.color}">${cnt}</strong></span>
        </div>
        <div style="background:#ffffff08;border-radius:6px;padding:10px 14px;">
          <div style="font-size:10px;color:${trans.color};text-transform:uppercase;letter-spacing:.1em;margin-bottom:5px">Â¿QuÃ© significa para el negocio?</div>
          <div style="font-size:12px;color:var(--dim);line-height:1.7">${trans.detail}</div>
        </div>
      </div>`;
    } else {
      html += `<div class="err-banner"><span style="font-size:20px">âš </span><div>
        <div style="font-size:11px;color:${C.red};text-transform:uppercase;letter-spacing:.1em;margin-bottom:2px">Error Dominante</div>
        <div style="color:var(--txt);font-family:monospace;font-size:13px">${esc(errKey)}</div>
        <div style="color:var(--dim);font-size:11px;margin-top:2px">Ocurrencias: <strong style="color:${C.red}">${cnt}</strong></div>
      </div></div>`;
    }
    if (loginCnt > 0 && errKey !== "Login failed for user 'xse.service.account'.") {
      html += `<div style="background:#1a1000;border:1px solid #f0a50066;border-left:4px solid ${loginTrans.color};border-radius:8px;padding:16px 18px;margin:12px 0;">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;flex-wrap:wrap;">
          <span style="font-size:22px">${loginTrans.icon}</span>
          <div style="flex:1;min-width:0;">
            <div style="font-size:10px;color:${loginTrans.color};text-transform:uppercase;letter-spacing:.12em;margin-bottom:3px">âš  Alerta de AutenticaciÃ³n Detectada</div>
            <div style="font-family:monospace;font-size:12px;color:var(--acc);word-break:break-all">Login failed for user 'xse.service.account'.</div>
          </div>
          <span style="font-size:11px;color:var(--dim);flex-shrink:0;">Ocurrencias: <strong style="color:${loginTrans.color}">${loginCnt}</strong></span>
        </div>
        <div style="background:#ffffff08;border-radius:6px;padding:10px 14px;">
          <div style="font-size:10px;color:${loginTrans.color};text-transform:uppercase;letter-spacing:.1em;margin-bottom:5px">Â¿QuÃ© significa para el negocio?</div>
          <div style="font-size:12px;color:var(--dim);line-height:1.7">${loginTrans.detail}</div>
        </div>
      </div>`;
    }
    return html;
  }

  const st=getTlState(name);
  const numDays=Object.keys(data.day_counts).length;
  // Auto-pick initial granularity based on day count
  if(!tlState[name]) {
    st.gran = numDays>90?"month":numDays>30?"week":"day";
    st.selectedIdx=null;
    st.daysLimit=0;
  }
  const buckets=getBuckets(data.day_counts, st.gran, st.daysLimit);

  // Compute actual first+last timestamp for period KPI
  const termEntries=allEntries().filter(e=>e[F.vt]===name);
  let pDate1="?", pTime1="?", pDate2="?", pTime2="?";
  if(termEntries.length){
    const sortedE=[...termEntries].sort((a,b)=>(a[F.ts]<b[F.ts]?-1:a[F.ts]>b[F.ts]?1:0));
    const first=sortedE[0], last=sortedE[sortedE.length-1];
    pDate1=first[F.date]; pTime1=first[F.time].slice(0,8);
    pDate2=last[F.date];  pTime2=last[F.time].slice(0,8);
  }

  const sliderMax=numDays;
  const sliderVal=st.daysLimit||sliderMax;

  document.getElementById("content").innerHTML=`
  <div class="kpi-row">
    <div class="kpi"><div class="kpi-label">Total Errores</div><div class="kpi-value" style="color:${sev.c}">${data.total.toLocaleString()}</div><div class="kpi-sub">Severidad: ${sev.l}</div></div>
    <div class="kpi"><div class="kpi-label">PerÃ­odo</div>
      <div style="margin-top:6px;font-family:monospace">
        <div style="font-size:13px;color:var(--teal);font-weight:700">${pDate1}</div>
        <div style="font-size:11px;color:var(--dim)">${pTime1}</div>
        <div style="font-size:10px;color:var(--mut);margin:4px 0 2px">â†’</div>
        <div style="font-size:13px;color:var(--teal);font-weight:700">${pDate2}</div>
        <div style="font-size:11px;color:var(--dim)">${pTime2}</div>
      </div>
      <div class="kpi-sub" style="margin-top:6px">${numDays} dÃ­a${numDays!==1?"s":""}  Â·  ${data.total} errores</div>
    </div>
    <div class="kpi"><div class="kpi-label">Componentes</div><div class="kpi-value" style="color:${C.blue}">${Object.keys(data.comp_counts).length}</div><div class="kpi-sub">afectados</div></div>
    <div class="kpi"><div class="kpi-label">MÃ©todos</div><div class="kpi-value" style="color:${C.mut}">${Object.keys(data.method_counts).length}</div><div class="kpi-sub">con errores</div></div>
  </div>
  ${buildErrBanners()}

  <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;margin:28px 0 10px;border-bottom:1px solid var(--bdr);padding-bottom:6px;">
    <div>
      <div style="font-size:11px;text-transform:uppercase;letter-spacing:.14em;color:var(--mut);">LÃ­nea de Tiempo â€” Errores</div>
      <div id="tl-period-label" style="font-size:11px;font-family:monospace;margin-top:3px">
        <span style="color:var(--teal)">${pDate1}</span> <span style="color:var(--dim)">${pTime1}</span> <span style="color:var(--mut)">â†’</span> <span style="color:var(--teal)">${pDate2}</span> <span style="color:var(--dim)">${pTime2}</span> <span style="color:var(--mut)">Â·  ${numDays} dÃ­a${numDays!==1?"s":""}</span>
      </div>
    </div>
    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
      <label style="font-size:10px;color:var(--mut);display:flex;flex-direction:column;gap:3px;min-width:180px">
        <span>Rango de dÃ­as: <strong id="tl-days-label" style="color:var(--acc)">Ãšltimos ${Math.min(sliderVal,numDays)} dÃ­as</strong></span>
        <input type="range" min="1" max="${sliderMax}" value="${sliderVal}"
          style="width:100%;accent-color:var(--acc);cursor:pointer"
          oninput="setTlDaysLimit('${name}',this.value)">
      </label>
    </div>
  </div>

  <div class="tl-wrap" style="padding:12px 14px;">
    <div style="font-size:10px;color:var(--mut);font-style:italic;margin-bottom:8px">ğŸ’¡ Haz clic en una barra para ver el detalle de ese perÃ­odo</div>
    <canvas id="chart-tl" style="width:100%;height:200px;cursor:pointer"
      onclick="tlCanvasClick(event,'${name}')"
      onmousemove="tlCanvasMousemove(event,'${name}')"
      onmouseleave="tlCanvasMouseleave(event,'${name}')"></canvas>
    <div id="tl-detail-container"></div>
  </div>

  <div class="sec-title">Desglose de Errores SQL</div>
  <div class="err-table"><table>
    <thead><tr><th>DescripciÃ³n</th><th style="text-align:right">Ocurrencias</th><th style="text-align:right">%</th></tr></thead>
    <tbody>${errE.map(([err,cnt])=>`<tr><td style="font-family:monospace;font-size:11px;color:var(--txt)">${esc(err)}</td><td style="color:var(--red);text-align:right;font-family:monospace;font-weight:700">${cnt}</td><td style="text-align:right"><span class="progress-bar"><span class="progress-fill" style="width:${Math.round(cnt/errT*100)}%"></span></span><span style="color:var(--dim);font-size:11px">${(cnt/errT*100).toFixed(1)}%</span></td></tr>`).join("")}</tbody>
  </table></div>`;

  setTimeout(()=>{
    drawTimeline("chart-tl", getBuckets(data.day_counts, st.gran, st.daysLimit), st.selectedIdx, null);
    if(st.selectedIdx!==null&&buckets[st.selectedIdx]){
      const container=document.getElementById("tl-detail-container");
      if(container) container.innerHTML=buildDayDetail(name,buckets[st.selectedIdx]);
    }
  },0);
}

// â”€â”€â”€ Log Viewer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getFiltered(){
  let rows=allEntries();
  const{search,fVT,fComp,fErr}=logState;
  if(fVT!=="all")rows=rows.filter(e=>e[F.vt]===fVT);
  if(fComp!=="all")rows=rows.filter(e=>e[F.comp]===fComp);
  if(fErr!=="all")rows=rows.filter(e=>e[F.ec]===fErr);
  if(search.trim()){const q=search.toLowerCase();rows=rows.filter(e=>e[F.meth].toLowerCase().includes(q)||e[F.ed].toLowerCase().includes(q)||e[F.comp].toLowerCase().includes(q)||e[F.date].includes(q));}
  return rows;
}
function getSorted(rows){
  const{sortKey,sortDir}=logState;
  const idx={ts:F.ts,date:F.ts,comp:F.comp,meth:F.meth,ec:F.ec,vt:F.vt}[sortKey]??F.ts;
  return[...rows].sort((a,b)=>{const va=a[idx]??"",vb=b[idx]??"";return sortDir==="asc"?(va<vb?-1:va>vb?1:0):(va>vb?-1:va<vb?1:0);});
}
function renderLogViewer(){
  const ae=allEntries();
  const uVTs=[...new Set(ae.map(e=>e[F.vt]))].sort();
  const uComps=[...new Set(ae.map(e=>e[F.comp]))].sort();
  const uErrs=[...new Set(ae.map(e=>e[F.ec]))].sort();
  const filtered=getFiltered(), sorted=getSorted(filtered);
  const{page,PER_PAGE,selected}=logState;
  const pages=Math.ceil(sorted.length/PER_PAGE)||1;
  const slice=sorted.slice(page*PER_PAGE,(page+1)*PER_PAGE);
  const th=(col,label)=>`<th class="${logState.sortKey===col?"sorted":""}" onclick="sortLog('${col}')">${label}${sortArrow(col)}</th>`;
  const selEntry=selected!==null?ae.find(e=>e[F.i]===selected):null;
  document.getElementById("content").innerHTML=`
  <div class="toolbar">
    <select class="filter-sel" onchange="logState.fVT=this.value;logState.page=0;renderLogViewer()">
      <option value="all" ${logState.fVT==="all"?"selected":""}>Todos los terminales</option>
      ${uVTs.map(v=>`<option value="${v}" ${logState.fVT===v?"selected":""}>${v}</option>`).join("")}
    </select>
    <select class="filter-sel" onchange="logState.fComp=this.value;logState.page=0;renderLogViewer()">
      <option value="all" ${logState.fComp==="all"?"selected":""}>Todos los componentes</option>
      ${uComps.map(v=>`<option value="${v}" ${logState.fComp===v?"selected":""}>${v}</option>`).join("")}
    </select>
    <select class="filter-sel" onchange="logState.fErr=this.value;logState.page=0;renderLogViewer()">
      <option value="all" ${logState.fErr==="all"?"selected":""}>Todos los errores</option>
      ${uErrs.map(v=>`<option value="${v}" ${logState.fErr===v?"selected":""}>SQL-${v}</option>`).join("")}
    </select>
    <span style="font-size:11px;color:var(--dim);white-space:nowrap;padding:0 4px">${sorted.length.toLocaleString()} resultados</span>
  </div>
  <div class="hint">ğŸ’¡ Haz clic en cualquier fila para ver el fragmento original del log</div>
  <div class="log-table-wrap">
    <div style="overflow-x:auto">
      <table class="log-table">
        <thead><tr>${th("date","Fecha")}${th("ts","Hora")}${th("vt","Terminal")}${th("comp","Componente")}${th("meth","MÃ©todo")}${th("ec","CÃ³digo")}<th>DescripciÃ³n</th></tr></thead>
        <tbody>${slice.map(e=>`<tr class="${selected===e[F.i]?"selected":""}" onclick="selectEntry(${e[F.i]})">
          <td style="color:var(--teal);font-family:monospace;font-size:11px;white-space:nowrap">${esc(e[F.date])}</td>
          <td style="color:var(--mut);font-family:monospace;font-size:11px;white-space:nowrap">${esc(e[F.time]).slice(0,8)}</td>
          <td><span class="tag tag-vt">${esc(e[F.vt])}</span></td>
          <td class="td-comp">${esc(e[F.comp])}</td>
          <td class="td-meth" title="${esc(e[F.meth])}">${esc(e[F.meth])}</td>
          <td>${ecTag(e[F.ec])}</td>
          <td class="td-desc" title="${esc(e[F.ed])}">${esc(e[F.ed])}</td>
        </tr>`).join("")}</tbody>
      </table>
    </div>
    <div class="pagination">
      <span class="page-info">PÃ¡gina ${page+1} de ${pages} Â· ${page*PER_PAGE+1}â€“${Math.min((page+1)*PER_PAGE,sorted.length)} de ${sorted.length.toLocaleString()}</span>
      <div class="page-btns">
        <button class="page-btn" onclick="goPage(0)" ${page===0?"disabled":""}>Â«</button>
        <button class="page-btn" onclick="goPage(${page-1})" ${page===0?"disabled":""}>â€¹</button>
        ${Array.from({length:Math.min(5,pages)},(_,i)=>{let p=page<3?i:page>pages-4?pages-5+i:page-2+i;if(p<0||p>=pages)return"";return`<button class="page-btn ${p===page?"active":""}" onclick="goPage(${p})">${p+1}</button>`;}).join("")}
        <button class="page-btn" onclick="goPage(${page+1})" ${page>=pages-1?"disabled":""}>â€º</button>
        <button class="page-btn" onclick="goPage(${pages-1})" ${page>=pages-1?"disabled":""}>Â»</button>
      </div>
    </div>
  </div>
  ${selEntry?renderRawPanel(selEntry):""}
  ${selEntry?`<div class="overlay" onclick="selectEntry(null)"></div>`:""}`;
}
function renderRawPanel(e){
  const ec=e[F.ec], color=ecColor(ec);
  const lineNo=e[F.lineNo]||"?";
  const rawText=e[F.raw]||"";
  const loginFlag=hasLoginFailed(rawText);
  const trans=getErrTranslation(e[F.ed], rawText);
  const loginTrans=ERR_TRANSLATIONS[0];
  const loginAlert=loginFlag?`
    <div style="background:#1a1000;border:1px solid #f0a50066;border-left:3px solid #f0a500;border-radius:6px;padding:10px 14px;margin-top:8px;">
      <div style="font-size:10px;color:#f0a500;text-transform:uppercase;letter-spacing:.1em;margin-bottom:4px">ğŸ” Fallo de autenticaciÃ³n detectado</div>
      <div style="font-size:11px;color:var(--dim);line-height:1.6">La cuenta <strong style="color:#f0a500;font-family:monospace">xse.service.account</strong> fue rechazada por SQL Server. El servidor es accesible pero la cuenta no tiene permisos. Requiere intervenciÃ³n del administrador de base de datos.</div>
    </div>`:"";
  const ecLabel = ec==="login"?"Auth Error":ec!=="0"?`SQL Error ${ec}`:"App Error";
  return `<div class="raw-panel">
    <div class="raw-panel-hd">
      <div class="raw-panel-meta">
        <div class="raw-panel-badges">
          <span class="badge" style="background:${color}22;color:${color};border-color:${color}44">${ecLabel}</span>
          <span style="font-size:10px;color:var(--mut);font-family:monospace">${esc(e[F.vt])} Â· thd-${esc(e[F.thd])}</span>
          <span style="font-size:10px;background:#2ec4b622;color:var(--teal);border:1px solid #2ec4b644;border-radius:4px;padding:2px 8px;font-family:monospace">LÃ­nea ${lineNo}</span>
        </div>
        <div class="raw-panel-method">${esc(e[F.meth])}</div>
        <div class="raw-panel-ts"><span style="color:var(--teal);font-family:monospace;font-weight:600">${esc(e[F.date])}</span><span style="color:var(--dim);font-family:monospace;margin-left:8px">${esc(e[F.time])}</span></div>
      </div>
      <button class="close-btn" onclick="selectEntry(null)">âœ•</button>
    </div>
    <div class="chips-row">
      ${[["Terminal",e[F.vt],C.acc],["Componente",e[F.comp],C.teal],["CÃ³digo",ec==="login"?"AUTH":ec!=="0"?`SQL-${ec}`:"App",color],["Thread",`thd-${e[F.thd]}`,C.blue],["LÃ­nea",`#${lineNo}`,C.teal]].map(([l,v,c])=>`<div class="chip" style="background:${c}18;border-color:${c}33"><div class="chip-lbl">${l}</div><div class="chip-val" style="color:${c}">${esc(v)}</div></div>`).join("")}
    </div>
    <div class="err-desc-row">
      <div style="font-size:10px;color:var(--acc);text-transform:uppercase;letter-spacing:.1em;margin-bottom:4px">DescripciÃ³n del Error</div>
      <div style="font-size:12px;color:#f5c842;font-family:monospace;line-height:1.5">${esc(e[F.ed])}</div>
      ${trans&&!loginFlag?`<div style="font-size:11px;color:var(--dim);line-height:1.6;background:#ffffff08;border-radius:5px;padding:8px 10px;margin-top:8px">${trans.icon} <strong style="color:${trans.color}">${trans.short}:</strong> ${trans.detail}</div>`:""}
      ${loginAlert}
    </div>
    <div class="raw-content-hd">
      <div class="raw-content-title">Fragmento Original Â· <span style="color:var(--teal);font-weight:600">LÃ­nea ${lineNo}</span></div>
      <button class="copy-btn" id="copy-raw-btn" onclick="copyRaw()">Copiar</button>
    </div>
    <div class="raw-content-body"><pre class="raw-pre">${hlRaw(rawText)}</pre></div>
  </div>`;
}

// â”€â”€â”€ Actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _searchTimer=null;
function logSearchInput(val){
  logState.search=val;logState.page=0;
  // Debounce slightly for performance
  clearTimeout(_searchTimer);
  _searchTimer=setTimeout(()=>{
    // Update results count and table without losing focus
    const filtered=getFiltered(), sorted=getSorted(filtered);
    const{page,PER_PAGE}=logState;
    const pages=Math.ceil(sorted.length/PER_PAGE)||1;
    const slice=sorted.slice(page*PER_PAGE,(page+1)*PER_PAGE);
    const tbody=document.querySelector(".log-table tbody");
    if(tbody){
      const{selected}=logState;
      tbody.innerHTML=slice.map(e=>`<tr class="${selected===e[F.i]?"selected":""}" onclick="selectEntry(${e[F.i]})">
        <td style="color:var(--teal);font-family:monospace;font-size:11px;white-space:nowrap">${esc(e[F.date])}</td>
        <td style="color:var(--mut);font-family:monospace;font-size:11px;white-space:nowrap">${esc(e[F.time]).slice(0,8)}</td>
        <td><span class="tag tag-vt">${esc(e[F.vt])}</span></td>
        <td class="td-comp">${esc(e[F.comp])}</td>
        <td class="td-meth" title="${esc(e[F.meth])}">${esc(e[F.meth])}</td>
        <td>${ecTag(e[F.ec])}</td>
        <td class="td-desc" title="${esc(e[F.ed])}">${esc(e[F.ed])}</td>
      </tr>`).join("");
    }
    // Update count
    const countEl=document.querySelector(".toolbar span:last-child");
    if(countEl) countEl.textContent=`${sorted.length.toLocaleString()} resultados`;
    // Update pagination
    const pgInfo=document.querySelector(".page-info");
    if(pgInfo) pgInfo.textContent=`PÃ¡gina ${page+1} de ${pages} Â· ${page*PER_PAGE+1}â€“${Math.min((page+1)*PER_PAGE,sorted.length)} de ${sorted.length.toLocaleString()}`;
  }, 80);
}
function sortLog(col){if(logState.sortKey===col)logState.sortDir=logState.sortDir==="asc"?"desc":"asc";else{logState.sortKey=col;logState.sortDir="desc";}logState.page=0;renderLogViewer();}
function goPage(p){logState.page=p;renderLogViewer();}
function selectEntry(id){logState.selected=logState.selected===id?null:id;renderLogViewer();}
function copyRaw(){
  const e=allEntries().find(x=>x[F.i]===logState.selected);if(!e)return;
  navigator.clipboard?.writeText(e[F.raw]||"").then(()=>{
    const btn=document.getElementById("copy-raw-btn");
    if(btn){btn.textContent="âœ“ Copiado";btn.classList.add("copied");setTimeout(()=>{btn.textContent="Copiar";btn.classList.remove("copied");},2000);}
  });
}

// â”€â”€â”€ Tab system â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildTabs(){
  const stats=allStats();
  if(!hasData()){document.getElementById("tabs").style.display="none";return;}
  const defs=[
    {id:"overview",l:"â—ˆ Vista General"},
    ...Object.keys(stats).map(k=>({id:k,l:`â¬¡ Terminal ${k}`})),
    {id:"logs",l:"â˜° Visor de Logs"},
  ];
  document.getElementById("tabs").style.display="flex";
  document.getElementById("tabs").innerHTML=defs.map(t=>`<button class="tab-btn ${activeTab===t.id?"active":""}" onclick="switchTab('${t.id}')">${t.l}</button>`).join("");
}
function switchTab(id){activeTab=id;if(id!=="logs")logState.selected=null;buildTabs();renderCurrentTab();}
function renderCurrentTab(){
  const stats=allStats();
  if(!hasData()){renderWelcome();return;}
  if(activeTab==="overview")renderOverview();
  else if(activeTab==="logs")renderLogViewer();
  else if(stats[activeTab])renderTerminal(activeTab);
}

// â”€â”€â”€ Parse log â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function parseLogText(name,text){
  const ERR_RE=/error: (\d+) - ([^)\n]{1,80})/i;
  const dc={},cc={},mc={},ec_c={};let total=0;const entries=[];
  const norm=text.replace(/\r\n/g,"\n").replace(/\r/g,"\n");
  const lines=norm.split("\n");

  // Build a char-offset â†’ line-number index for fast lookup
  const lineOffsets=[0];
  for(let i=0;i<lines.length;i++) lineOffsets.push(lineOffsets[i]+lines[i].length+1);
  function charToLine(offset){
    let lo=0,hi=lineOffsets.length-1;
    while(lo<hi){const mid=(lo+hi+1)>>1;if(lineOffsets[mid]<=offset)lo=mid;else hi=mid-1;}
    return lo+1; // 1-based
  }

  const parts=norm.split(/(?=Error\tEvent-)/).filter(Boolean);
  let charOffset=0;
  parts.forEach(raw=>{
    const hm=raw.match(/Error\tEvent-\d+\s+(\d{2}\/\d{2}\/\d{4})\s+(\d{2}:\d{2}:\d{2}\.\d+)\s+\(thd-(\d+)\)\t(\w+)\s+(\S+)/);
    const lineNo=charToLine(charOffset);
    charOffset+=raw.length;
    if(!hm)return; total++;
    const[,,date,time_s,thd,comp,meth]=hm;
    const em=ERR_RE.exec(raw);
    // For login failed, no SQL error code â€” detect inline
    const loginFailed=hasLoginFailed(raw);
    let ec_v, ed_v;
    if(loginFailed && !em){
      ec_v="login"; ed_v="Login failed for user 'xse.service.account'.";
    } else {
      ec_v=em?em[1]:"0";
      ed_v=em?em[2].trim().slice(0,60):(raw.split("\n")[0].split(meth)[1]||"").replace(/\{[^}]+\}/g,"").trim().slice(0,60)||"Ver detalle";
    }
    dc[date]=(dc[date]||0)+1;cc[comp]=(cc[comp]||0)+1;mc[meth]=(mc[meth]||0)+1;ec_c[ed_v]=(ec_c[ed_v]||0)+1;
    const rawLines=raw.split("\n").map(l=>l.trim()).filter(Boolean);
    const nonSt=rawLines.filter(l=>!l.startsWith("en "));
    const st=rawLines.filter(l=>l.startsWith("en "));
    const neat=nonSt.join("\n")+(st.length?"\n\nStack trace:\n"+st.join("\n"):"");
    const[d,mo,y]=date.split("/");
    const timeDisplay=time_s; // keep full time including milliseconds
    // entry array: [i, vt, date, time, ts, thd, comp, meth, ec, ed, raw, lineNo]
    entries.push([entries.length,name,date,timeDisplay,`${y}-${mo}-${d}T${time_s}`,thd,comp,meth,ec_v,ed_v,neat.slice(0,700),lineNo]);
  });
  // Sort dates chronologically using ISO conversion (DD/MM/YYYY â†’ YYYY-MM-DD)
  const toISO=d=>{const[dd,mm,yy]=d.split("/");return`${yy}-${mm}-${dd}`;};
  const dates=Object.keys(dc).sort((a,b)=>toISO(a)<toISO(b)?-1:toISO(a)>toISO(b)?1:0);
  return{
    stats:{total,date_range:dates.length?[dates[0],dates[dates.length-1]]:["?","?"],
      day_counts:dc,
      comp_counts:Object.fromEntries(Object.entries(cc).sort((a,b)=>b[1]-a[1])),
      method_counts:Object.fromEntries(Object.entries(mc).sort((a,b)=>b[1]-a[1])),
      err_counts:Object.fromEntries(Object.entries(ec_c).sort((a,b)=>b[1]-a[1]))},
    entries,
  };
}

// â”€â”€â”€ File handling â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handleFiles(files){
  const fileList=Array.from(files); if(!fileList.length)return;
  const pending={done:0,total:fileList.length,results:[],newStats:{},newEntries:[]};

  fileList.forEach(f=>{
    const reader=new FileReader();
    reader.onload=e=>{
      const text=e.target.result;
      const validation=validateXSE(text);
      const name=f.name.replace(/\.log$/,"").split("_").pop().toUpperCase();

      if(validation.isValid){
        const{stats,entries}=parseLogText(name,text);
        // Re-index globally
        const offset=pending.newEntries.length;
        const reindexed=entries.map((row,i)=>{const r=row.slice();r[F.i]=offset+i;return r;});
        pending.newStats[name]=stats;
        pending.newEntries.push(...reindexed);
        pending.results.push({filename:f.name,validation,entries:entries.length});
      } else {
        pending.results.push({filename:f.name,validation,entries:0});
      }

      pending.done++;
      if(pending.done===pending.total){
        // Replace all data
        currentStats=pending.newStats;
        currentEntries=pending.newEntries;
        activeTab=Object.keys(pending.newStats).length?"overview":"overview";
        logState={search:"",fVT:"all",fComp:"all",fErr:"all",sortKey:"ts",sortDir:"desc",page:0,selected:null,PER_PAGE:50};
        // Reset per-terminal timeline state
        Object.keys(tlState).forEach(k=>delete tlState[k]);

        renderValidationCards(pending.results);

        const validCount=pending.results.filter(r=>r.validation.isValid).length;
        const totalE=currentEntries.length;
        const terms=Object.keys(currentStats).length;

        const dot=document.getElementById("status-dot");
        const stxt=document.getElementById("status-text");
        if(terms>0){
          dot.className="status-dot active";
          stxt.textContent=`${totalE.toLocaleString()} entradas Â· ${terms} terminal${terms!==1?"es":""}`;
        } else {
          dot.className="status-dot idle";
          stxt.textContent=`Sin datos vÃ¡lidos (${pending.results.length} archivo${pending.results.length!==1?"s":""} rechazado${pending.results.length!==1?"s":""})`;
        }

        buildTabs();
        renderCurrentTab();
        // Reset file input so same file can be re-loaded
        document.getElementById("file-input").value="";
      }
    };
    reader.readAsText(f);
  });
}

// â”€â”€â”€ Upload wiring â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const zone=document.getElementById("upload-zone");
const fileInput=document.getElementById("file-input");
zone.addEventListener("dragover",e=>{e.preventDefault();zone.classList.add("drag");});
zone.addEventListener("dragleave",()=>zone.classList.remove("drag"));
zone.addEventListener("drop",e=>{e.preventDefault();zone.classList.remove("drag");handleFiles(e.dataTransfer.files);});
fileInput.addEventListener("change",e=>handleFiles(e.target.files));

// â”€â”€â”€ Resize â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _rt;window.addEventListener("resize",()=>{clearTimeout(_rt);_rt=setTimeout(()=>renderCurrentTab(),200);});

// â”€â”€â”€ Code protection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function(){
  // Disable right-click context menu
  document.addEventListener("contextmenu",e=>e.preventDefault());

  // Disable common keyboard shortcuts for dev tools and view source
  document.addEventListener("keydown",e=>{
    const k=e.key.toUpperCase();
    // F12
    if(e.key==="F12"){e.preventDefault();return;}
    // Ctrl/Cmd + U (view source), Ctrl+Shift+I/J/C (devtools), Ctrl+S (save)
    if((e.ctrlKey||e.metaKey)&&(k==="U"||k==="S")){e.preventDefault();return;}
    if((e.ctrlKey||e.metaKey)&&e.shiftKey&&(k==="I"||k==="J"||k==="C")){e.preventDefault();return;}
  });

  // Disable text selection on most elements (allow inputs/textareas)
  const styleEl=document.createElement("style");
  styleEl.textContent=`body{-webkit-user-select:none;-moz-user-select:none;user-select:none;}input,textarea,pre,.raw-pre{-webkit-user-select:text;-moz-user-select:text;user-select:text;}`;
  document.head.appendChild(styleEl);

  // Disable drag
  document.addEventListener("dragstart",e=>e.preventDefault());

  // Basic DevTools open detection via window size diff
  let _dtOpen=false;
  const _dtCheck=()=>{
    const threshold=160;
    const widthDiff=window.outerWidth-window.innerWidth>threshold;
    const heightDiff=window.outerHeight-window.innerHeight>threshold;
    if((widthDiff||heightDiff)&&!_dtOpen){
      _dtOpen=true;
      document.body.style.filter="blur(8px)";
      document.body.style.pointerEvents="none";
    } else if(!widthDiff&&!heightDiff&&_dtOpen){
      _dtOpen=false;
      document.body.style.filter="";
      document.body.style.pointerEvents="";
    }
  };
  setInterval(_dtCheck,1000);
  window.addEventListener("resize",_dtCheck);
})();

// â”€â”€â”€ Owner modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleOwnerModal(){
  const m=document.getElementById("owner-modal");
  m.style.display=m.style.display==="flex"?"none":"flex";
}
document.addEventListener("keydown",e=>{if(e.key==="Escape")document.getElementById("owner-modal").style.display="none";});

// â”€â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
renderWelcome();

// â”€â”€â”€ PWA Service Worker (inline, cache-first for offline) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if('serviceWorker' in navigator){
  const swCode=`
    const CACHE='xse-log-v1';
    self.addEventListener('install',e=>{self.skipWaiting();});
    self.addEventListener('activate',e=>{e.waitUntil(caches.keys().then(ks=>Promise.all(ks.filter(k=>k!==CACHE).map(k=>caches.delete(k)))));});
    self.addEventListener('fetch',e=>{
      if(e.request.method!=='GET')return;
      e.respondWith(caches.open(CACHE).then(cache=>cache.match(e.request).then(r=>{
        const fetched=fetch(e.request).then(res=>{if(res.ok)cache.put(e.request,res.clone());return res;}).catch(()=>{});
        return r||fetched;
      })));
    });
  `;
  const blob=new Blob([swCode],{type:'application/javascript'});
  navigator.serviceWorker.register(URL.createObjectURL(blob)).catch(()=>{});
}
</script>
</body>
</html>